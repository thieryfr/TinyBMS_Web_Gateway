# Victron PGN signal synthesis

This note consolidates the ten Victron CAN-Bus PGNs transmitted by the TinyBMS bridge, highlighting the payload structure, data sources, scaling/aggregations and the nominal publication rate. Identifiers are defined in `bridge_pgn_defs.h`, which also documents the standard scaling factors and 0x35A alarm bit packing.【F:docs/bridge_pgn_defs.h†L2-L58】 All PGNs below share the 1 Hz transmission interval configured by `pgn_update_interval_ms_ = 1000`, while the Victron keep-alive heartbeat (0x305) is also sent every second but is treated separately as RX/TX handshake traffic.【F:docs/tinybms_victron_bridge.h†L118-L128】【F:docs/bridge_can.cpp†L692-L710】

| PGN (hex) | Frame name | Fields & TinyBMS sources | Conversion / aggregation | Publish timing |
|-----------|------------|--------------------------|--------------------------|----------------|
| 0x351 | Charge voltage/current limits | • ChargeVoltageLimit: dynamic CVL derived from live pack voltage (reg 36) with overrides when `stats.cvl_current_v` is set.<br>• MaxChargeCurrent CCL: starts from reg 103 (`max_charge_current` in 0.1 A) and can be overridden by `stats.ccl_limit_a`.<br>• MaxDischargeCurrent DCL: starts from reg 102 (`max_discharge_current` in 0.1 A) and can be overridden by `stats.dcl_limit_a`.【F:docs/bridge_can.cpp†L525-L536】【F:docs/reference/tiny_reg_mapping_sheet1_extract.md†L7-L9】 | • CVL encoded as 0.01 V (×100).<br>• CCL/DCL encoded as 0.1 A (×10).<br>Logic ensures positive unsigned outputs for Victron expectations.【F:docs/bridge_can.cpp†L525-L536】【F:docs/reference/tiny_reg_mapping_sheet1_extract.md†L7-L9】 | 1 Hz (shared PGN interval). | 
| 0x355 | State-of-charge / health | • SOC: live `soc_percent` based on Tiny register 46 (0.002 %).<br>• SOH: live `soh_percent` from Tiny register 45 (0.002 %).【F:docs/bridge_can.cpp†L506-L517】【F:docs/reference/tiny_reg_mapping_sheet1_extract.md†L10-L11】 | Both fields scaled to 0.1 % (×10) before packing into unsigned 16-bit values.【F:docs/bridge_can.cpp†L513-L516】【F:docs/reference/tiny_reg_mapping_sheet1_extract.md†L10-L11】 | 1 Hz. |
| 0x356 | Pack voltage/current/temperature | • BatteryVoltage: live pack voltage from register 36 (float volts).<br>• BatteryCurrent: live pack current from register 38 (float amps, discharge negative).<br>• BatteryTemperature: internal temperature from register 48 (0.1 °C).【F:docs/bridge_can.cpp†L491-L503】【F:docs/reference/tiny_reg_mapping_sheet1_extract.md†L12-L14】 | Voltage quantized to 0.01 V (×100), current to 0.1 A (×10, signed), temperature kept in native 0.1 °C units.【F:docs/bridge_can.cpp†L497-L503】【F:docs/reference/tiny_reg_mapping_sheet1_extract.md†L12-L14】 | 1 Hz. |
| 0x35A | Alarm & warning bit pairs | Full Victron matrix of 2-bit statuses (0 = OK, 1 = warning, 2 = alarm, 3 = reserved).<br>• Bytes 0–3 encode alarms: general summary, high/low voltage, high/low temperature (interne & charge), discharge/charge over-current and cell imbalance. Reserved contactor/short/BMS bits are forced to `0b11`.<br>• Bytes 4–7 mirror warnings: general warning level plus pre-alerts (±5 % ou +5 °C d’hystérésis) for les mêmes grandeurs, y compris la coupure de charge basse température via `low_temp_charge_cutoff_c` (reg 0x0140).<br>• Cell imbalance warning réplique le niveau, tandis que `System Status` reste réservé (0b11).【F:main/can_publisher/conversion_table.c†L115-L206】【F:main/can_publisher/conversion_table.c†L434-L547】【F:main/uart_bms/uart_bms_protocol.c†L229-L260】 | `encode_2bit_field` garantit les niveaux Victron, en s’appuyant sur les seuils TinyBMS (`*_cutoff`, limites courant) et la température externe `auxiliary_temperature_c` pour les alarmes de charge. Les bits réservés sont explicitement renseignés et les résumés généraux se lisent dans les bytes 0/4.【F:main/can_publisher/conversion_table.c†L115-L206】【F:main/can_publisher/conversion_table.c†L434-L547】 | 1 Hz. |
| 0x35E | Manufacturer string | Eight ASCII characters from register 500 when available; falls back to Victron config `manufacturer_name` or defaults to “TinyBMS”.【F:docs/bridge_can.cpp†L612-L618】【F:docs/reference/tiny_reg_mapping_sheet1_extract.md†L35-L35】 | ASCII padded with zeros per Victron requirements.【F:docs/reference/tiny_reg_mapping_sheet1_extract.md†L35-L35】 | 1 Hz. |
| 0x35F | Battery info string | Eight ASCII characters for the battery name: prioritises Victron config `battery_name`, otherwise register 502, default “Lithium Battery”.【F:docs/bridge_can.cpp†L620-L626】【F:docs/reference/tiny_reg_mapping_sheet1_extract.md†L36-L36】 | ASCII padded to 8 bytes.【F:docs/reference/tiny_reg_mapping_sheet1_extract.md†L36-L36】 | 1 Hz. |
| 0x371 | Battery name (part 2) | Second 8-byte slice of the battery name string (characters 9–16), using same source priority as 0x35F to satisfy Victron display expectations.【F:docs/bridge_can.cpp†L628-L634】【F:docs/reference/tiny_reg_mapping_sheet1_extract.md†L37-L37】 | ASCII padded to 8 bytes.【F:docs/reference/tiny_reg_mapping_sheet1_extract.md†L37-L37】 | 1 Hz. |
| 0x378 | Energy counters | • EnergyIn: integrates positive power (charging) using live voltage/current and elapsed time via `updateEnergyCounters`.<br>• EnergyOut: integrates discharge energy similarly.【F:docs/bridge_can.cpp†L453-L488】【F:docs/bridge_can.cpp†L636-L647】【F:docs/reference/tiny_reg_mapping_sheet1_extract.md†L38-L39】 | Energy values encoded as unsigned 32-bit integers with 100 Wh resolution (`encodeEnergyWh`).【F:docs/bridge_can.cpp†L636-L647】【F:docs/reference/tiny_reg_mapping_sheet1_extract.md†L38-L39】 | 1 Hz (reflecting cumulative totals). |
| 0x379 | Installed capacity | Pulls 0.01 Ah snapshot from register 306 when available; otherwise uses configured nominal capacity. Values are clamped to the 0–65535 Ah Victron range before encoding.【F:docs/bridge_can.cpp†L649-L671】【F:docs/reference/tiny_reg_mapping_sheet1_extract.md†L37-L40】 | Rounded to nearest Ah and packed as unsigned 16-bit value.【F:docs/bridge_can.cpp†L655-L671】 | 1 Hz. |
| 0x382 | Battery family string | ASCII family/chemistry label from register 502, falling back to battery name if absent, padded to eight bytes.【F:docs/bridge_can.cpp†L674-L680】【F:docs/reference/tiny_reg_mapping_sheet1_extract.md†L41-L41】 | ASCII padded to 8 bytes.【F:docs/reference/tiny_reg_mapping_sheet1_extract.md†L41-L41】 | 1 Hz. |

## Additional CAN traffic

- **0x305 Keepalive:** Heartbeat frames used to maintain Victron link health; handled separately as part of the keepalive task (RX/TX handshake).【F:docs/bridge_pgn_defs.h†L10-L20】【F:docs/reference/tiny_reg_mapping_sheet1_extract.md†L41-L43】  
- **0x307 Handshake:** Victron inverter identification exchange consumed by the bridge on RX only.【F:docs/reference/tiny_reg_mapping_sheet1_extract.md†L42-L43】

These auxiliary IDs share the 1 s cadence defined by `keepalive_interval_ms_ = 1000` and the timeout guard at 10 s, ensuring Victron devices see a continuously alive BMS.【F:docs/tinybms_victron_bridge.h†L118-L128】
