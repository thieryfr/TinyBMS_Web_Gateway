# API Endpoints

## REST API Overview
| Method | Path | Description | Request Body | Success Response | Error Codes |
| ------ | ---- | ----------- | ------------ | ---------------- | ----------- |
| GET | `/api/status` | Gateway runtime snapshot. | _None_ | `200 OK` with JSON produced by `monitoring_get_status_json`. | `500 Internal Server Error` when the status snapshot cannot be generated. |
| GET | `/api/config` | Persisted configuration export. | _None_ | `200 OK` with JSON from `config_manager_get_config_json`. | `500 Internal Server Error` on load failure. |
| POST | `/api/config` | Persisted configuration update. | JSON configuration (≤ `CONFIG_MANAGER_MAX_CONFIG_SIZE`). | `200 OK` with `{ "status": "updated" }`. | `400 Bad Request` for empty/invalid payload, `413 Payload Too Large` when exceeding storage size, `500 Internal Server Error` on read failures. |
| GET | `/api/mqtt/config` | Active MQTT client settings. | _None_ | `200 OK` with JSON describing broker URI, topics and QoS defaults. | `500 Internal Server Error` if configuration is unavailable or exceeds buffer size. |
| POST | `/api/mqtt/config` | MQTT client and topic configuration update. | JSON containing broker URI components, credentials, QoS, retain flag and topic names. | `200 OK` with `{ "status": "updated" }`. | `400 Bad Request` for validation failures (host/port/URI/topic updates), `413 Payload Too Large` when exceeding buffer, `500 Internal Server Error` on read errors. |
| GET | `/api/mqtt/status` | MQTT runtime status. | _None_ | `200 OK` with JSON summarising connectivity counters and last event metadata. | `500 Internal Server Error` if the status payload would overflow the buffer. |
| GET | `/api/history` | Telemetry history export. Supports `?limit=<n>` query parameter. | _None_ | `200 OK` with JSON array generated by `monitoring_get_history_json`. | `500 Internal Server Error` when history retrieval fails. |
| GET | `/api/registers` | Register catalogue snapshot. | _None_ | `200 OK` with JSON from `config_manager_get_registers_json`. | `500 Internal Server Error` on retrieval failure. |
| POST | `/api/registers` | Register update batch. | JSON payload describing register writes. | `200 OK` with `{ "status": "updated" }`. | `400 Bad Request` for empty/invalid payloads, `413 Payload Too Large` when exceeding buffer, `500 Internal Server Error` on receive errors. |
| POST | `/api/ota` | OTA image upload notification. | Binary firmware image streamed in the request body. | `200 OK` with `{ "status": "accepted" }` and OTA readiness event emission. | `400 Bad Request` for empty bodies, `500 Internal Server Error` on receive failures. |
| GET | `/*` | Static asset delivery from SPIFFS (`/` resolves to `/index.html`). | _None_ | `200 OK` with the requested file and appropriate content type. | `400 Bad Request` for insecure paths, `404 Not Found` when asset is missing, `414 URI Too Long` when the path overflows. |

## REST Endpoint Details

### `GET /api/status`
- **Response body**: JSON snapshot identical to the telemetry status broadcast (battery metrics, connection state). No cache headers are emitted (`Cache-Control: no-store`).
- **Failure cases**: Returns `500` if `monitoring_get_status_json` reports an error.

### `GET /api/config`
- **Response body**: Configuration JSON persisted by the configuration manager. `Cache-Control: no-store` prevents stale caches.
- **Failure cases**: `500` if configuration retrieval fails.

### `POST /api/config`
- **Request body**: Full configuration JSON (UTF-8). Must be ≤ `CONFIG_MANAGER_MAX_CONFIG_SIZE` bytes.
- **Response**: `{ "status": "updated" }` when validation and persistence succeed.
- **Failure cases**: `400` for empty or invalid JSON, `413` when payload exceeds limits, `500` for transport errors.

### `GET /api/mqtt/config`
- **Response body**: Broker URI decomposition, credentials, keepalive, QoS defaults and topic names.
- **Failure cases**: `500` if the MQTT configuration cannot be read or serialised.

### `POST /api/mqtt/config`
- **Request body**: JSON fields `scheme`, `host`, `port`, `username`, `password`, `keepalive`, `default_qos`, `retain`, and topic overrides (`status_topic`, `metrics_topic`, `config_topic`, `can_raw_topic`, `can_decoded_topic`, `can_ready_topic`).
- **Response**: `{ "status": "updated" }` when both client and topic settings persist successfully.
- **Failure cases**: `400` when host/port validation, URI construction or persistence fails; `413` if payload exceeds buffer; `500` on socket read errors.

### `GET /api/mqtt/status`
- **Response body**: Runtime counters (`reconnects`, `disconnects`, `errors`), connectivity flags, last event metadata, broker URI and topic names.
- **Failure cases**: `500` if the status JSON would overflow the response buffer.

### `GET /api/history`
- **Query parameters**: Optional `limit` (integer) to cap the number of samples returned.
- **Response body**: JSON history array emitted by `monitoring_get_history_json`. `Cache-Control: no-store` is applied.
- **Failure cases**: `500` when history data cannot be generated.

### `GET /api/registers`
- **Response body**: JSON representing the register catalogue (`config_manager_get_registers_json`).
- **Failure cases**: `500` when the catalogue cannot be generated.

### `POST /api/registers`
- **Request body**: JSON payload describing register write operations, within `CONFIG_MANAGER_MAX_CONFIG_SIZE` bytes.
- **Response**: `{ "status": "updated" }` when register updates succeed.
- **Failure cases**: `400` for empty or invalid payloads, `413` for oversized payloads, `500` when socket reads fail.

### `POST /api/ota`
- **Request body**: Binary firmware image streamed in arbitrary chunk sizes.
- **Response**: `{ "status": "accepted" }`; additionally posts `APP_EVENT_ID_OTA_UPLOAD_READY` to the internal event bus.
- **Failure cases**: `400` for zero-length uploads, `500` if chunk reception fails.

### `GET /*`
- **Response body**: Static file contents sourced from SPIFFS. Requests to `/` serve `index.html`.
- **Failure cases**: `400` for insecure traversal attempts, `404` when the file is missing, `414` when the requested path exceeds buffer limits.

## WebSocket Streams
All WebSocket endpoints upgrade using `GET` and exchange UTF-8 encoded text frames.

| URI | Initial Message | Stream Payloads |
| --- | --------------- | ---------------- |
| `/ws/telemetry` | Emits the same JSON document as `GET /api/status` immediately after connection. | Subsequent frames mirror telemetry samples published with `APP_EVENT_ID_TELEMETRY_SAMPLE`.
| `/ws/events` | Sends `{ "event": "connected" }` as an acknowledgement. | Broadcasts event bus notifications for `APP_EVENT_ID_UI_NOTIFICATION`, `APP_EVENT_ID_CONFIG_UPDATED`, and `APP_EVENT_ID_OTA_UPLOAD_READY`.
| `/ws/uart` | Sends `{ "type": "uart", "status": "connected" }`. | Forwards UART frames produced by `APP_EVENT_ID_UART_FRAME_RAW` and `APP_EVENT_ID_UART_FRAME_DECODED`.
| `/ws/can` | Sends `{ "type": "can", "status": "connected" }`. | Forwards CAN frames emitted via `APP_EVENT_ID_CAN_FRAME_RAW` and `APP_EVENT_ID_CAN_FRAME_DECODED`.

## Versioning and Access Control
| Path | API Version | Access Level | Notes |
| ---- | ----------- | ------------ | ----- |
| `/api/*` | v1 | Local network (no authentication enforced) | Constrained devices typically deploy behind a trusted LAN; add authentication if exposed externally.
| `/ws/*` | v1 | Local network (no authentication enforced) | WebSocket clients inherit the same access assumptions as REST endpoints.
| `/*` | Static | Local network (no authentication enforced) | Serves UI assets packaged within the firmware image.

> ℹ️ Share this document with the Product/UX team for validation so that naming, payload semantics, and user-facing contract remain aligned with UI expectations.
