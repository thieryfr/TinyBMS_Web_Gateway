================================================================================
ANALYSE APPROFONDIE - TinyBMS-GW COMMUNICATIONS
================================================================================
Date: 2025-11-10
Projet: TinyBMS Gateway pour Victron Cerbo GX (ESP32)

================================================================================
1. REGISTRES MODBUS (59 mots 16-bit, polling 250ms)
================================================================================

FICHIERS CLÉS:
  /home/user/TinyBMS-GW/main/uart_bms/uart_bms_protocol.h
    → Énumérations: UART_BMS_REGISTER_* (45 registres)
    → Structure: uart_bms_register_metadata_t

  /home/user/TinyBMS-GW/main/uart_bms/uart_bms_protocol.c
    → Table: g_uart_bms_registers[UART_BMS_REGISTER_COUNT]
    → Adresses poll: g_uart_bms_poll_addresses[59]

  /home/user/TinyBMS-GW/main/uart_bms/uart_bms.h
    → Structure: uart_bms_live_data_t (tous les champs de données)

REGISTRES RÉSUMÉ (45):
  Addresses 0x0000-0x000F: Voltages cellules 1-16 (UINT16, scale 0.1mV)
  Address 0x0020: Lifetime counter (UINT32)
  Address 0x0024-0x0026: Pack Voltage/Current (FLOAT32)
  Address 0x0028-0x0029: Min/Max cell voltages
  Address 0x002A-0x002B: External temperatures 1-2
  Address 0x002D: State of Health (UINT16, scale 0.002%)
  Address 0x002E: State of Charge HIGH PRECISION (UINT32, scale 0.000001%)
  Address 0x0030: Internal MOS Temperature
  Address 0x0032-0x0034: System Status, Balancing flags
  Address 0x0066-0x0067: Max Discharge/Charge Current
  Address 0x0071: Pack Temperature Min/Max
  Address 0x0131-0x0140: Configuration (capacity, cutoffs, limits)
  Address 0x01F4-0x01F6: Hardware/Firmware versions

TOTAL: 59 mots polled, 45 registres uniques

================================================================================
2. CAN ID VICTRON (25 PGN, bitrate 500kbps)
================================================================================

FICHIERS CLÉS:
  /home/user/TinyBMS-GW/main/can_publisher/conversion_table.c
    → Lines 50-69: PGN definitions (VICTRON_PGN_*)
    → Lines 325-1300: Encodeurs (functions)
    → Identifiants 11-bit: utilisation directe des PGN (0x305–0x382)
    → Priorité logique=6, Source address=0xE5 (métadonnées)

  /home/user/TinyBMS-GW/main/can_victron/can_victron.c
    → Keepalive ID: 0x305
    → Interval: 1000ms
    → TWAI driver + thread safety

  /home/user/TinyBMS-GW/main/include/can_config_defaults.h
    → GPIO TX: 7, GPIO RX: 6
    → Bitrate: 250000 bps
    → Keepalive timeout: 10000ms

PGN TABLE (19 PGN):
  0x305: Keepalive (0x00)
  0x307: Handshake ("VIC")
  0x351: CVL/CCL/DCL (charge limits)
  0x355: SOC/SOH
  0x356: Voltage/Current/Temperature
  0x35A: Alarms
  0x35E: Manufacturer
  0x35F: Battery Info
  0x370-0x371: BMS Name (Part 1-2)
  0x372: Module Status
  0x373: Cell Extremes
  0x374-0x375: Min/Max Cell ID
  0x376-0x377: Min/Max Temp ID
  0x378: Energy Counters
  0x379: Installed Capacity
  0x380-0x381: Serial (Part 1-2)
  0x382: Battery Family

KEEPALIVE:
  ID: 0x305
  Interval: 1000ms
  Timeout: 10000ms
  Payload: 1 byte

================================================================================
3. APIs REST ET WEBSOCKETS
================================================================================

FICHIERS CLÉS:
  /home/user/TinyBMS-GW/main/web_server/web_server.h
    → Documentation endpoints (lines 14-35)

  /home/user/TinyBMS-GW/main/web_server/web_server.c
    → Endpoints REST: lines 2609-2700+
    → WebSocket handlers: lines 2834-2878

  /home/user/TinyBMS-GW/web/src/js/utils/fetchAPI.js
    → Client API wrapper (retry logic, error handling)

REST ENDPOINTS:
  GET  /api/status              → État global système
  GET  /api/config              → Configuration actuelle
  POST /api/config              → Mettre à jour configuration
  GET  /api/metrics/runtime     → Métriques runtime
  GET  /api/event-bus/metrics   → Statistiques événements
  GET  /api/system/tasks        → Liste tasks FreeRTOS
  GET  /api/system/modules      → État modules
  POST /api/system/restart      → Redémarrage système
  GET  /api/can/status          → État bus CAN
  GET  /api/alerts/config       → Configuration alertes
  POST /api/alerts/config       → Mettre à jour alertes
  GET  /api/alerts/active       → Alertes actives
  GET  /api/alerts/history      → Historique alertes
  POST /api/alerts/acknowledge  → Valider alertes
  POST /api/ota                 → Upload firmware

WEBSOCKET ENDPOINTS:
  /ws/telemetry                 → BMS telemetry (250ms)
  /ws/events                    → System events
  /ws/uart                      → UART raw data
  /ws/can                       → CAN frames monitoring
  /ws/alerts                    → Alert notifications

Rate limiting: 10 msg/sec per client, 32KB max payload

================================================================================
4. FICHIERS SOURCE COMPLETS
================================================================================

MODBUS/UART BMS:
  /home/user/TinyBMS-GW/main/uart_bms/uart_bms_protocol.h
  /home/user/TinyBMS-GW/main/uart_bms/uart_bms_protocol.c
  /home/user/TinyBMS-GW/main/uart_bms/uart_bms.h
  /home/user/TinyBMS-GW/main/uart_bms/uart_bms.cpp
  /home/user/TinyBMS-GW/main/uart_bms/uart_frame_builder.h
  /home/user/TinyBMS-GW/main/uart_bms/uart_frame_builder.cpp
  /home/user/TinyBMS-GW/main/uart_bms/uart_response_parser.h
  /home/user/TinyBMS-GW/main/uart_bms/uart_response_parser.cpp

CAN VICTRON:
  /home/user/TinyBMS-GW/main/can_victron/can_victron.h
  /home/user/TinyBMS-GW/main/can_victron/can_victron.c
  /home/user/TinyBMS-GW/main/can_publisher/conversion_table.h
  /home/user/TinyBMS-GW/main/can_publisher/conversion_table.c
  /home/user/TinyBMS-GW/main/can_publisher/can_publisher.h
  /home/user/TinyBMS-GW/main/can_publisher/can_publisher.c
  /home/user/TinyBMS-GW/main/can_publisher/cvl_controller.h
  /home/user/TinyBMS-GW/main/can_publisher/cvl_controller.c
  /home/user/TinyBMS-GW/main/can_publisher/cvl_types.h
  /home/user/TinyBMS-GW/main/include/can_config_defaults.h

WEB SERVER & APIs:
  /home/user/TinyBMS-GW/main/web_server/web_server.h
  /home/user/TinyBMS-GW/main/web_server/web_server.c
  /home/user/TinyBMS-GW/main/web_server/web_server_alerts.h
  /home/user/TinyBMS-GW/main/web_server/web_server_alerts.c
  /home/user/TinyBMS-GW/web/src/js/utils/fetchAPI.js
  /home/user/TinyBMS-GW/web/src/components/alerts/alerts.js
  /home/user/TinyBMS-GW/web/src/js/utils/canTooltips.js

CONFIGURATION & MONITORING:
  /home/user/TinyBMS-GW/main/config_manager/config_manager.h
  /home/user/TinyBMS-GW/main/config_manager/config_manager.c
  /home/user/TinyBMS-GW/main/monitoring/monitoring.h
  /home/user/TinyBMS-GW/main/monitoring/monitoring.c
  /home/user/TinyBMS-GW/main/alert_manager/alert_manager.h
  /home/user/TinyBMS-GW/main/alert_manager/alert_manager.c
  /home/user/TinyBMS-GW/main/system_metrics/system_metrics.h
  /home/user/TinyBMS-GW/main/system_metrics/system_metrics.c

INFRASTRUCTURE:
  /home/user/TinyBMS-GW/main/event_bus/event_bus.h
  /home/user/TinyBMS-GW/main/event_bus/event_bus.c
  /home/user/TinyBMS-GW/main/include/app_events.h
  /home/user/TinyBMS-GW/main/app_main.c

================================================================================
5. DOCUMENTATION GÉNÉRÉE
================================================================================

FICHIERS DE DOCUMENTATION CRÉÉS:
  
  1. /home/user/TinyBMS-GW/DOCUMENTATION_COMMUNICATIONS.md
     → Documentation complète (3000+ lignes)
     → Registres Modbus avec tableaux détaillés
     → PGN Victron avec encodage
     → APIs REST et WebSocket avec exemples JSON
     → Formats de données et structures

  2. /home/user/TinyBMS-GW/docs/COMMUNICATION_REFERENCE.json
     → Données structurées en JSON
     → Tables PGN, endpoints API, WebSocket
     → Facile à parser programmatiquement

  3. /home/user/TinyBMS-GW/FILES_REFERENCE.md
     → Référence rapide des fichiers source
     → Flux de données complet
     → Points d'intégration clés
     → Commandes utiles

  4. /home/user/TinyBMS-GW/ANALYSIS_SUMMARY.txt
     → Ce fichier (résumé complet)

================================================================================
6. RÉSUMÉ DES DONNÉES
================================================================================

FLUX GLOBAL:
  TinyBMS (batterie)
    ↓ UART Modbus (250ms polling)
  uart_bms_protocol.c (59 registres, 45 uniques)
    ↓ uart_bms_live_data_t
  conversion_table.c (BMS → CAN)
    ↓ 25 PGN Victron (250kbps CAN)
  Cerbo GX / Victron System

+ Parallèlement: Web Server REST API (JSON) + WebSocket (real-time)

ADRESSES MODBUS CLÉS:
  0x0000-0x000F (16 words):  Cell voltages
  0x0020-0x0034 (21 words):  Primary data (voltage, current, SOC, temp)
  0x0066-0x0071 (7 words):   Current limits & temps
  0x0131-0x0140 (16 words):  Configuration
  0x01F4-0x01FF (12 words):  Versions & reserved

CAN MESSAGES CLÉS:
  0x351: Charge limits (CVL/CCL/DCL) - 100ms
  0x355: SOC/SOH - 1000ms
  0x356: Voltage/Current/Temp - 1000ms
  0x378: Energy counters - 10000ms
  0x373: Cell extremes - 1000ms

API MESSAGES:
  /api/status: Full system status JSON
  /api/config: Configuration with masked passwords
  /ws/telemetry: Real-time BMS data every 250ms
  /ws/can: CAN frame monitoring
  /ws/alerts: Alert notifications on change

================================================================================
7. POINTS DE DÉMARRAGE
================================================================================

Pour comprendre le projet:
  1. Lire uart_bms_protocol.c (lignes 1-577): tous les registres
  2. Lire conversion_table.c (lignes 50-69): tous les CAN IDs
  3. Lire web_server.h (lignes 14-35): tous les endpoints
  4. Consulter DOCUMENTATION_COMMUNICATIONS.md pour détails complets

Pour ajouter un registre Modbus:
  1. Éditer uart_bms_protocol.h: ajouter enum
  2. Éditer uart_bms_protocol.c: ajouter à g_uart_bms_registers[]
  3. Mettre à jour UART_BMS_REGISTER_WORD_COUNT

Pour ajouter un message CAN:
  1. Éditer conversion_table.c: ajouter #define VICTRON_PGN_*
  2. Implémenter encoder function
  3. Ajouter channel au registry

Pour ajouter un endpoint API:
  1. Éditer web_server.h: documenter
  2. Éditer web_server.c: implémenter handler + register
  3. Tester avec curl ou postman

================================================================================
Version: 1.0
Generated: 2025-11-10
Project: TinyBMS-GW (ESP32 Victron Gateway)
================================================================================
