<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TinyBMS - Test Simple</title>
    <link rel="stylesheet" href="/assets/css/tabler.min.css" />
    <link rel="stylesheet" href="/assets/css/tabler-icons.min.css" />
    <link rel="stylesheet" href="/style.css" />
    <!-- Using CDN version (full) instead of local simple version which lacks gauge component -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body class="theme-dark">
    <div class="page">
        <header class="navbar navbar-dark app-header">
            <div class="container-xl">
                <h1 class="navbar-brand">üîã TinyBMS - Version Simplifi√©e</h1>
            </div>
        </header>

        <main class="page-body">
            <div class="container-xl">
                <!-- Status Cards -->
                <div class="row row-cards g-3 mb-4">
                    <div class="col-sm-6 col-xl-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <span class="avatar avatar-lg bg-primary-lt me-3">
                                        <i class="ti ti-bolt"></i>
                                    </span>
                                    <div>
                                        <div class="text-secondary">Tension pack</div>
                                        <div class="h2 mb-0" id="voltage">-- V</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-sm-6 col-xl-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <span class="avatar avatar-lg bg-warning-lt me-3">
                                        <i class="ti ti-current-ac"></i>
                                    </span>
                                    <div>
                                        <div class="text-secondary">Courant pack</div>
                                        <div class="h2 mb-0" id="current">-- A</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-sm-6 col-xl-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <span class="avatar avatar-lg bg-success-lt me-3">
                                        <i class="ti ti-battery-charging"></i>
                                    </span>
                                    <div>
                                        <div class="text-secondary">√âtat de charge</div>
                                        <div class="h2 mb-0" id="soc">-- %</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-sm-6 col-xl-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <span class="avatar avatar-lg bg-danger-lt me-3">
                                        <i class="ti ti-temperature"></i>
                                    </span>
                                    <div>
                                        <div class="text-secondary">Temp√©rature</div>
                                        <div class="h2 mb-0" id="temp">-- ¬∞C</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Gauge -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Jauge de Test - SOC</h3>
                            </div>
                            <div class="card-body">
                                <div id="test-soc-gauge" style="width: 100%; height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Jauge de Test - Temp√©rature</h3>
                            </div>
                            <div class="card-body">
                                <div id="test-temp-gauge" style="width: 100%; height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Details -->
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Donn√©es D√©taill√©es</h3>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr><th>Voltage min</th><td id="min-cell">-- mV</td></tr>
                                    <tr><th>Voltage max</th><td id="max-cell">-- mV</td></tr>
                                    <tr><th>SOH</th><td id="soh">-- %</td></tr>
                                    <tr><th>√âquilibrage</th><td id="balancing">--</td></tr>
                                    <tr><th>Cycles</th><td id="cycles">--</td></tr>
                                    <tr><th>Capacit√©</th><td id="capacity">-- Ah</td></tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Cellules (16)</h3>
                            </div>
                            <div class="card-body">
                                <div id="cells" class="d-flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Console Log -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h3 class="card-title">Console de Debug</h3>
                    </div>
                    <div class="card-body">
                        <pre id="console" style="max-height: 200px; overflow-y: auto; font-size: 11px;"></pre>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Get echarts from global scope
        const echarts = window.echarts;

        // Simple logging
        const consoleDiv = document.getElementById('console');
        function log(msg) {
            const time = new Date().toLocaleTimeString();
            consoleDiv.textContent = `[${time}] ${msg}\n` + consoleDiv.textContent;
            console.log(msg);
        }

        log('Page charg√©e');

        // Initialize gauges
        let socGauge = null;
        let tempGauge = null;

        function initGauges() {
            try {
                if (!echarts) {
                    log('‚úó ECharts non disponible');
                    return;
                }
                log('Initialisation des jauges...');

                // SOC Gauge
                const socElement = document.getElementById('test-soc-gauge');
                if (socElement) {
                    socGauge = echarts.init(socElement);
                    const socOption = {
                        tooltip: {
                            formatter: '{a} <br/>{b} : {c}%'
                        },
                        series: [
                            {
                                name: 'SOC',
                                type: 'gauge',
                                startAngle: 220,
                                endAngle: -40,
                                min: 0,
                                max: 100,
                                splitNumber: 5,
                                radius: '80%',
                                axisLine: {
                                    lineStyle: {
                                        width: 20,
                                        color: [
                                            [0.5, '#f25f5c'],
                                            [0.8, '#ffd166'],
                                            [1, '#00a896']
                                        ]
                                    }
                                },
                                pointer: {
                                    itemStyle: {
                                        color: 'auto'
                                    },
                                    width: 6,
                                    length: '70%'
                                },
                                axisTick: {
                                    distance: -20,
                                    length: 8,
                                    lineStyle: {
                                        color: '#fff',
                                        width: 2
                                    }
                                },
                                splitLine: {
                                    distance: -20,
                                    length: 15,
                                    lineStyle: {
                                        color: '#fff',
                                        width: 4
                                    }
                                },
                                axisLabel: {
                                    color: 'rgba(255,255,255,0.8)',
                                    distance: 25,
                                    fontSize: 14
                                },
                                detail: {
                                    valueAnimation: true,
                                    formatter: '{value}%',
                                    color: '#f2f5f7',
                                    fontSize: 28,
                                    fontWeight: 'bold',
                                    offsetCenter: [0, '70%']
                                },
                                data: [
                                    {
                                        value: 0,
                                        name: '√âtat de charge'
                                    }
                                ]
                            }
                        ]
                    };
                    socGauge.setOption(socOption);
                    log('‚úì Jauge SOC initialis√©e');
                }

                // Temperature Gauge
                const tempElement = document.getElementById('test-temp-gauge');
                if (tempElement) {
                    tempGauge = echarts.init(tempElement);
                    const tempOption = {
                        tooltip: {
                            formatter: '{a} <br/>{b} : {c}¬∞C'
                        },
                        series: [
                            {
                                name: 'Temp√©rature',
                                type: 'gauge',
                                startAngle: 220,
                                endAngle: -40,
                                min: -20,
                                max: 80,
                                splitNumber: 5,
                                radius: '80%',
                                axisLine: {
                                    lineStyle: {
                                        width: 20,
                                        color: [
                                            [0.3, '#00a896'],
                                            [0.6, '#ffd166'],
                                            [1, '#f25f5c']
                                        ]
                                    }
                                },
                                pointer: {
                                    itemStyle: {
                                        color: 'auto'
                                    },
                                    width: 6,
                                    length: '70%'
                                },
                                axisTick: {
                                    distance: -20,
                                    length: 8,
                                    lineStyle: {
                                        color: '#fff',
                                        width: 2
                                    }
                                },
                                splitLine: {
                                    distance: -20,
                                    length: 15,
                                    lineStyle: {
                                        color: '#fff',
                                        width: 4
                                    }
                                },
                                axisLabel: {
                                    color: 'rgba(255,255,255,0.8)',
                                    distance: 25,
                                    fontSize: 14,
                                    formatter: '{value}¬∞'
                                },
                                detail: {
                                    valueAnimation: true,
                                    formatter: '{value}¬∞C',
                                    color: '#f2f5f7',
                                    fontSize: 28,
                                    fontWeight: 'bold',
                                    offsetCenter: [0, '70%']
                                },
                                data: [
                                    {
                                        value: 0,
                                        name: 'Temp√©rature'
                                    }
                                ]
                            }
                        ]
                    };
                    tempGauge.setOption(tempOption);
                    log('‚úì Jauge temp√©rature initialis√©e');
                }

                // Handle window resize
                window.addEventListener('resize', () => {
                    socGauge?.resize();
                    tempGauge?.resize();
                });
            } catch (e) {
                log('‚úó Erreur init gauges: ' + e.message);
                console.error('Gauge init error:', e);
            }
        }

        function updateGauges(data) {
            try {
                if (socGauge && data.state_of_charge_pct != null) {
                    socGauge.setOption({
                        series: [{
                            data: [{ value: data.state_of_charge_pct, name: '√âtat de charge' }]
                        }]
                    });
                }

                if (tempGauge && data.average_temperature_c != null) {
                    tempGauge.setOption({
                        series: [{
                            data: [{ value: data.average_temperature_c, name: 'Temp√©rature' }]
                        }]
                    });
                }
            } catch (e) {
                log('‚úó Erreur update gauges: ' + e.message);
            }
        }

        // Update functions
        function updateDisplay(data) {
            try {
                document.getElementById('voltage').textContent = (data.pack_voltage_v || 0).toFixed(2) + ' V';
                document.getElementById('current').textContent = (data.pack_current_a || 0).toFixed(2) + ' A';
                document.getElementById('soc').textContent = (data.state_of_charge_pct || 0).toFixed(1) + ' %';
                document.getElementById('temp').textContent = (data.average_temperature_c || 0).toFixed(1) + ' ¬∞C';

                document.getElementById('min-cell').textContent = (data.min_cell_mv || 0) + ' mV';
                document.getElementById('max-cell').textContent = (data.max_cell_mv || 0) + ' mV';
                document.getElementById('soh').textContent = (data.state_of_health_pct || 0).toFixed(1) + ' %';
                document.getElementById('balancing').textContent = data.balancing_bits > 0 ? 'Actif' : 'Inactif';
                document.getElementById('cycles').textContent = data.cycle_count || 0;
                document.getElementById('capacity').textContent = (data.battery_capacity_ah || 0) + ' Ah';

                // Update cells
                const cellsDiv = document.getElementById('cells');
                if (data.cell_voltage_mv && data.cell_voltage_mv.length > 0) {
                    cellsDiv.innerHTML = data.cell_voltage_mv.map((mv, i) =>
                        `<span class="badge bg-blue-lt">C${i+1}: ${mv}mV</span>`
                    ).join('');
                }

                // Update gauges
                updateGauges(data);

                log(`Donn√©es mises √† jour: SOC ${data.state_of_charge_pct}%`);
            } catch (e) {
                log('Erreur updateDisplay: ' + e.message);
            }
        }

        // Test API first
        async function testAPI() {
            try {
                log('Test API /api/status...');
                const res = await fetch('/api/status');
                const data = await res.json();
                log('‚úì API fonctionne');

                if (data.battery) {
                    updateDisplay(data.battery);
                }
            } catch (e) {
                log('‚úó Erreur API: ' + e.message);
            }
        }

        // Connect WebSocket
        function connectWS() {
            try {
                const ws = new WebSocket('ws://localhost:3000/ws/telemetry');

                ws.onopen = () => {
                    log('‚úì WebSocket connect√©');
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        updateDisplay(data);
                    } catch (e) {
                        log('‚úó Erreur parse WS: ' + e.message);
                    }
                };

                ws.onerror = (error) => {
                    log('‚úó Erreur WebSocket: ' + error);
                };

                ws.onclose = () => {
                    log('WebSocket ferm√©, reconnexion dans 3s...');
                    setTimeout(connectWS, 3000);
                };
            } catch (e) {
                log('‚úó Erreur connectWS: ' + e.message);
            }
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            log('DOM ready');
            // Wait a bit for echarts to load
            setTimeout(() => {
                initGauges();
                testAPI();
                setTimeout(connectWS, 1000);
            }, 100);
        });
    </script>
</body>
</html>
