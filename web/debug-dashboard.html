<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Dashboard.js</title>
    <link rel="stylesheet" href="/assets/css/tabler.min.css">
    <style>
        body {
            padding: 40px;
            background: #1e1e2e;
            color: #fff;
            font-family: system-ui;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .success { background: #2d5f2e; }
        .error { background: #5f2d2d; }
        .warning { background: #5f4d2d; }
        .info { background: #2d3e5f; }

        .debug-section {
            background: #2a2a3e;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .debug-section h3 {
            margin-top: 0;
            color: #00a896;
        }

        .code {
            background: #1e1e2e;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .test-list {
            list-style: none;
            padding: 0;
        }

        .test-list li {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
        }

        .test-pass { background: #2d5f2e; }
        .test-fail { background: #5f2d2d; }
        .test-warn { background: #5f4d2d; }

        .btn {
            background: #00a896;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        .btn:hover {
            background: #008c7a;
        }
    </style>
</head>
<body>
    <h1>üîç Debug Dashboard.js</h1>

    <div id="status" class="status info">Pr√©paration des tests...</div>

    <div class="debug-section">
        <h3>Actions de test</h3>
        <button class="btn" onclick="runAllTests()">üîÑ Relancer tous les tests</button>
        <button class="btn" onclick="testModuleImport()">üì¶ Tester import des modules</button>
        <button class="btn" onclick="clearLogs()">üóëÔ∏è Effacer les logs</button>
    </div>

    <div class="debug-section">
        <h3>Tests de pr√©-requis</h3>
        <ul id="test-results" class="test-list"></ul>
    </div>

    <div class="debug-section">
        <h3>Console en temps r√©el</h3>
        <div id="console-log" class="code"></div>
    </div>

    <div class="debug-section">
        <h3>Informations d√©taill√©es</h3>
        <div id="debug-info" class="code"></div>
    </div>

    <!-- Hidden DOM elements that dashboard.js expects -->
    <div style="display: none;">
        <div id="history-chart"></div>
        <div id="battery-soc-gauge"></div>
        <div id="uart-frames-chart"></div>
        <div id="history-table-body"></div>
        <div id="mqtt-messages-chart"></div>
        <div id="battery-pack-sparkline"></div>
        <div id="battery-cell-chart"></div>
        <div id="can-heatmap-chart"></div>
        <div id="can-throughput-chart"></div>
        <div id="uart-timeline-raw"></div>
        <div id="uart-timeline-decoded"></div>
        <div id="can-timeline-raw"></div>
        <div id="can-timeline-decoded"></div>
    </div>

    <!-- Load ECharts before dashboard.js -->
    <script src="/assets/js/echarts.simple.min.js"></script>

    <script>
        const statusDiv = document.getElementById('status');
        const testResultsDiv = document.getElementById('test-results');
        const debugInfoDiv = document.getElementById('debug-info');
        const consoleLogDiv = document.getElementById('console-log');

        let tests = [];
        let debugInfo = [];
        let consoleLog = [];

        // Capture all console outputs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' ');
            consoleLog.push('[LOG] ' + new Date().toLocaleTimeString() + ' - ' + msg);
            originalLog.apply(console, args);
            updateConsole();
        };

        console.error = function(...args) {
            const msg = args.map(a => {
                if (a instanceof Error) return a.stack || a.message;
                if (typeof a === 'object') return JSON.stringify(a, null, 2);
                return String(a);
            }).join(' ');
            consoleLog.push('[ERROR] ' + new Date().toLocaleTimeString() + ' - ' + msg);
            originalError.apply(console, args);
            updateConsole();
        };

        console.warn = function(...args) {
            const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' ');
            consoleLog.push('[WARN] ' + new Date().toLocaleTimeString() + ' - ' + msg);
            originalWarn.apply(console, args);
            updateConsole();
        };

        function addTest(name, passed, details) {
            tests.push({ name, passed, details });
            updateTests();
        }

        function addDebugInfo(info) {
            debugInfo.push(info);
            updateDebugInfo();
        }

        function updateTests() {
            testResultsDiv.innerHTML = tests.map(test => {
                const className = test.passed === 'warn' ? 'test-warn' : (test.passed ? 'test-pass' : 'test-fail');
                const icon = test.passed === 'warn' ? '‚ö†Ô∏è' : (test.passed ? '‚úÖ' : '‚ùå');
                return `<li class="${className}">
                    ${icon} ${test.name}
                    ${test.details ? '<br><small>' + test.details + '</small>' : ''}
                </li>`;
            }).join('');
        }

        function updateDebugInfo() {
            debugInfoDiv.textContent = debugInfo.join('\n');
        }

        function updateConsole() {
            consoleLogDiv.textContent = consoleLog.slice(-100).join('\n'); // Keep last 100 logs
            consoleLogDiv.scrollTop = consoleLogDiv.scrollHeight;
        }

        function clearLogs() {
            consoleLog = [];
            updateConsole();
        }

        async function runAllTests() {
            tests = [];
            debugInfo = [];
            statusDiv.className = 'status info';
            statusDiv.textContent = 'üîÑ Tests en cours...';

            console.log('=== D√©but des tests Dashboard.js ===');

            // Test 1: ECharts disponible
            if (typeof window.echarts !== 'undefined') {
                addTest('ECharts charg√© (window.echarts)', true, 'Version: ' + window.echarts.version);
                addDebugInfo('‚úì window.echarts disponible (version ' + window.echarts.version + ')');
            } else {
                addTest('ECharts charg√© (window.echarts)', false, 'window.echarts is undefined');
                addDebugInfo('‚úó window.echarts n\'est pas disponible');
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå ECharts non charg√© - arr√™t des tests';
                return;
            }

            // Test 2: V√©rifier les m√©thodes ECharts n√©cessaires
            const requiredEchartsMethods = ['init', 'registerTheme', 'connect', 'disconnect', 'dispose'];
            const missingMethods = requiredEchartsMethods.filter(method => typeof window.echarts[method] !== 'function');
            if (missingMethods.length === 0) {
                addTest('M√©thodes ECharts requises', true, 'Toutes pr√©sentes: ' + requiredEchartsMethods.join(', '));
                addDebugInfo('‚úì Toutes les m√©thodes ECharts requises sont disponibles');
            } else {
                addTest('M√©thodes ECharts requises', false, 'Manquantes: ' + missingMethods.join(', '));
                addDebugInfo('‚úó M√©thodes manquantes: ' + missingMethods.join(', '));
            }

            // Test 3: V√©rifier les √©l√©ments DOM requis
            const requiredElements = ['history-chart', 'battery-soc-gauge', 'uart-frames-chart', 'history-table-body', 'mqtt-messages-chart'];
            const missingElements = requiredElements.filter(id => !document.getElementById(id));
            if (missingElements.length === 0) {
                addTest('√âl√©ments DOM requis', true, requiredElements.length + ' √©l√©ments trouv√©s');
                addDebugInfo('‚úì Tous les √©l√©ments DOM requis sont pr√©sents');
            } else {
                addTest('√âl√©ments DOM requis', 'warn', 'Manquants: ' + missingElements.join(', '));
                addDebugInfo('‚ö† √âl√©ments DOM manquants: ' + missingElements.join(', '));
            }

            // Test 4: V√©rifier que les scripts peuvent importer des modules
            try {
                const supportsModules = 'noModule' in HTMLScriptElement.prototype;
                addTest('Support des modules ES6', supportsModules, 'Navigateur: ' + navigator.userAgent.split(' ').pop());
                addDebugInfo(supportsModules ? '‚úì Modules ES6 support√©s' : '‚úó Modules ES6 non support√©s');
            } catch (e) {
                addTest('Support des modules ES6', false, e.message);
                addDebugInfo('‚úó Erreur v√©rification modules: ' + e.message);
            }

            // Test 5: V√©rifier les propri√©t√©s ECharts d√©taill√©es
            const echartsProps = Object.keys(window.echarts);
            addDebugInfo('\nPropri√©t√©s ECharts (' + echartsProps.length + ' total):');
            addDebugInfo(echartsProps.sort().join(', '));

            // Test 6: Test d'import dynamique
            console.log('Test import des modules dashboard.js...');
            await testModuleImport();

            console.log('=== Fin des tests ===');
        }

        async function testModuleImport() {
            try {
                // Test 1: Import de base.js
                addTest('Import de base.js', 'info', 'Tentative...');
                const baseModule = await import('/src/js/charts/base.js');
                addTest('Import de base.js', true, 'Exports: ' + Object.keys(baseModule).join(', '));
                addDebugInfo('‚úì base.js import√© avec succ√®s');
                addDebugInfo('  Exports: ' + Object.keys(baseModule).join(', '));

                // V√©rifier si echarts est export√© correctement
                if (baseModule.echarts) {
                    addTest('base.js exporte echarts', true, 'Version: ' + (baseModule.echarts.version || 'unknown'));
                    addDebugInfo('‚úì base.js exporte echarts correctement');
                } else {
                    addTest('base.js exporte echarts', false, 'echarts non export√©');
                    addDebugInfo('‚úó base.js n\'exporte pas echarts');
                }

                // Test 2: Import de batteryCharts.js
                try {
                    const batteryModule = await import('/src/js/charts/batteryCharts.js');
                    addTest('Import de batteryCharts.js', true, 'Exports: ' + Object.keys(batteryModule).join(', '));
                    addDebugInfo('‚úì batteryCharts.js import√© avec succ√®s');
                } catch (e) {
                    addTest('Import de batteryCharts.js', false, e.message);
                    addDebugInfo('‚úó Erreur batteryCharts.js: ' + e.message);
                    console.error('Erreur import batteryCharts:', e);
                }

                // Test 3: Import de dashboard.js
                try {
                    // D√©clencher l'√©v√©nement partials-loaded avant d'importer dashboard.js
                    document.documentElement.dataset.partialsLoaded = 'true';

                    console.log('D√©clenchement de l\'√©v√©nement partials-loaded...');
                    document.dispatchEvent(new CustomEvent('partials-loaded'));

                    await new Promise(resolve => setTimeout(resolve, 100));

                    addTest('Import de dashboard.js', 'info', 'Tentative...');
                    const dashboardModule = await import('/dashboard.js');
                    addTest('Import de dashboard.js', true, 'Module charg√©');
                    addDebugInfo('‚úì dashboard.js import√© avec succ√®s');

                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ Tous les modules se chargent correctement!';
                } catch (e) {
                    addTest('Import de dashboard.js', false, e.message);
                    addDebugInfo('‚úó Erreur dashboard.js: ' + e.message);
                    addDebugInfo('Stack: ' + (e.stack || 'N/A'));
                    console.error('Erreur import dashboard:', e);

                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå Erreur lors du chargement de dashboard.js';
                }

            } catch (e) {
                addTest('Import des modules', false, e.message);
                addDebugInfo('‚úó Erreur import: ' + e.message);
                addDebugInfo('Stack: ' + (e.stack || 'N/A'));
                console.error('Erreur import modules:', e);

                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Erreur lors des imports';
            }
        }

        // Lancer les tests au chargement
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 100);
        });

        // Capturer les erreurs globales
        window.addEventListener('error', (event) => {
            console.error('Erreur globale:', event.error || event.message);
            addDebugInfo('‚ö† ERREUR GLOBALE: ' + (event.error ? event.error.message : event.message));
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Promise rejet√©e:', event.reason);
            addDebugInfo('‚ö† PROMISE REJET√âE: ' + (event.reason ? event.reason.message : event.reason));
        });
    </script>
</body>
</html>
