<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Configuration MQTT - TinyBMS Gateway</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />

    <!-- Tabler CSS + Icons -->
    <link rel="stylesheet" href="/assets/css/tabler.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.44.0/tabler-icons.min.css" />

    <!-- Styles personnalisés -->
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body class="theme-dark">
    <div class="page">
      <!-- Header simple -->
      <header class="navbar navbar-expand-md navbar-dark app-header">
        <div class="container-xl">
          <div class="app-logo">
            <div class="app-logo-icon">
              <i class="ti ti-settings"></i>
            </div>
            <div class="app-logo-text">
              <div class="app-logo-title">Configuration MQTT</div>
              <div class="app-logo-subtitle">TinyBMS Gateway</div>
            </div>
          </div>
          <div class="ms-auto">
            <a href="/" class="btn btn-outline-primary">
              <i class="ti ti-arrow-left me-2"></i>
              Retour au Dashboard
            </a>
          </div>
        </div>
      </header>

      <!-- Main content -->
      <main class="page-body">
        <div class="container-xl">
          <div class="row g-3 mt-3">
            <!-- Status Card -->
            <div class="col-lg-4">
              <div class="card">
                <div class="card-header d-flex flex-wrap align-items-center gap-2">
                  <h3 class="card-title mb-0">État du broker</h3>
                  <button id="mqtt-refresh" class="btn btn-outline-primary btn-sm ms-auto">Actualiser</button>
                </div>
                <div class="card-body">
                  <div class="d-flex flex-wrap align-items-center gap-3">
                    <span id="mqtt-connection-state" class="badge status-badge">--</span>
                    <span id="mqtt-last-error" class="text-secondary small" aria-live="polite">Aucune erreur</span>
                  </div>
                  <dl class="status-kv mt-3">
                    <div><dt>Client</dt><dd id="mqtt-client-started">--</dd></div>
                    <div><dt>Wi-Fi</dt><dd id="mqtt-wifi-state">--</dd></div>
                    <div><dt>Reconnexions</dt><dd id="mqtt-reconnect-count">0</dd></div>
                    <div><dt>Déconnexions</dt><dd id="mqtt-disconnect-count">0</dd></div>
                    <div><dt>Erreurs</dt><dd id="mqtt-error-count">0</dd></div>
                    <div><dt>Dernier événement</dt><dd id="mqtt-last-event">--</dd></div>
                    <div><dt>Horodatage</dt><dd id="mqtt-last-event-time">--</dd></div>
                  </dl>
                </div>
              </div>
            </div>

            <!-- Configuration Form -->
            <div class="col-lg-8">
              <form id="mqtt-config-form" class="card">
                <div class="card-header">
                  <h3 class="card-title mb-0">
                    <i class="ti ti-settings-cog me-2"></i>
                    Configuration de la passerelle MQTT
                  </h3>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label for="mqtt-scheme" class="form-label">Schéma</label>
                      <select id="mqtt-scheme" name="scheme" class="form-select">
                        <option value="mqtt">mqtt</option>
                        <option value="mqtts">mqtts</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="mqtt-port" class="form-label">Port</label>
                      <input id="mqtt-port" name="port" type="number" class="form-control" min="1" max="65535" required>
                    </div>
                    <div class="col-12">
                      <label for="mqtt-host" class="form-label">Hôte</label>
                      <input id="mqtt-host" name="host" type="text" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                      <label for="mqtt-username" class="form-label">Utilisateur</label>
                      <input id="mqtt-username" name="username" type="text" class="form-control">
                    </div>
                    <div class="col-md-6">
                      <label for="mqtt-password" class="form-label">Mot de passe</label>
                      <input id="mqtt-password" name="password" type="password" class="form-control">
                    </div>
                    <div class="col-md-6">
                      <label for="mqtt-keepalive" class="form-label">Keepalive (s)</label>
                      <input id="mqtt-keepalive" name="keepalive" type="number" class="form-control" min="0">
                    </div>
                    <div class="col-md-6">
                      <label for="mqtt-qos" class="form-label">QoS par défaut</label>
                      <input id="mqtt-qos" name="default_qos" type="number" class="form-control" min="0" max="2">
                    </div>
                    <div class="col-12">
                      <div class="form-check form-switch">
                        <input id="mqtt-retain" name="retain" type="checkbox" class="form-check-input">
                        <label class="form-check-label" for="mqtt-retain">Retenir l'état</label>
                      </div>
                    </div>
                  </div>

                  <fieldset class="mt-4">
                    <legend class="small text-uppercase text-secondary">Topics personnalisés</legend>
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label for="mqtt-status-topic" class="form-label">Statut</label>
                        <input id="mqtt-status-topic" name="status_topic" type="text" class="form-control">
                      </div>
                      <div class="col-md-6">
                        <label for="mqtt-metrics-topic" class="form-label">Mesures</label>
                        <input id="mqtt-metrics-topic" name="metrics_topic" type="text" class="form-control">
                      </div>
                      <div class="col-md-6">
                        <label for="mqtt-config-topic" class="form-label">Configuration</label>
                        <input id="mqtt-config-topic" name="config_topic" type="text" class="form-control">
                      </div>
                      <div class="col-md-6">
                        <label for="mqtt-can-raw-topic" class="form-label">CAN brut</label>
                        <input id="mqtt-can-raw-topic" name="can_raw_topic" type="text" class="form-control">
                      </div>
                      <div class="col-md-6">
                        <label for="mqtt-can-decoded-topic" class="form-label">CAN décodé</label>
                        <input id="mqtt-can-decoded-topic" name="can_decoded_topic" type="text" class="form-control">
                      </div>
                      <div class="col-md-6">
                        <label for="mqtt-can-ready-topic" class="form-label">CAN prêts</label>
                        <input id="mqtt-can-ready-topic" name="can_ready_topic" type="text" class="form-control">
                      </div>
                    </div>
                  </fieldset>
                </div>
                <div class="card-footer">
                  <button type="submit" class="btn btn-primary w-100">
                    <i class="ti ti-device-floppy me-2"></i>
                    Enregistrer la configuration
                  </button>
                  <p id="mqtt-config-message" class="mt-2 mb-0 small text-center" role="status" aria-live="polite"></p>
                </div>
              </form>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script defer src="/assets/js/tabler.min.js"></script>

    <!-- JavaScript for MQTT configuration -->
    <script type="module">
      // Fetch and display MQTT status
      async function fetchMqttStatus() {
        try {
          const res = await fetch('/api/mqtt/status', { cache: 'no-store' });
          if (!res.ok) throw new Error('Status failed');
          const status = await res.json();
          updateMqttStatus(status);
        } catch (err) {
          updateMqttStatus(null, err);
        }
      }

      function updateMqttStatus(status, error) {
        const badge = document.getElementById('mqtt-connection-state');
        const helper = document.getElementById('mqtt-last-error');
        if (!badge || !helper) return;

        badge.className = 'status-badge';
        helper.classList.remove('text-danger');

        const set = (id, value) => {
          const el = document.getElementById(`mqtt-${id}`);
          if (el) el.textContent = value;
        };

        const reset = () => {
          ['client-started', 'wifi-state', 'reconnect-count', 'disconnect-count', 'error-count', 'last-event', 'last-event-time'].forEach((id) => {
            set(id, '--');
          });
        };

        if (error) {
          reset();
          badge.textContent = 'Erreur';
          badge.classList.add('status-badge--error');
          helper.textContent = error.message || 'Statut indisponible';
          helper.classList.add('text-danger');
          return;
        }

        if (!status) {
          reset();
          badge.textContent = 'Inconnu';
          badge.classList.add('status-badge--disconnected');
          helper.textContent = 'Aucune donnée';
          return;
        }

        if (status.connected) {
          badge.textContent = 'Connecté';
          badge.classList.add('status-badge--connected');
        } else if (status.client_started) {
          badge.textContent = 'Déconnecté';
          badge.classList.add('status-badge--disconnected');
        } else {
          badge.textContent = 'Arrêté';
          badge.classList.add('status-badge--error');
        }

        helper.textContent = status.last_error ? status.last_error : 'Aucune erreur récente';
        if (status.last_error) helper.classList.add('text-danger');

        set('client-started', status.client_started ? 'Actif' : 'Arrêté');
        set('wifi-state', status.wifi_connected ? 'Connecté' : 'Déconnecté');
        set('reconnect-count', String(status.reconnects ?? 0));
        set('disconnect-count', String(status.disconnects ?? 0));
        set('error-count', String(status.errors ?? 0));
        set('last-event', status.last_event || '--');

        const ts = Number(status.last_event_timestamp_ms);
        set('last-event-time', Number.isFinite(ts) && ts > 0 ? new Date(ts).toLocaleString() : '--');
      }

      // Fetch and populate configuration
      async function fetchMqttConfig() {
        try {
          const res = await fetch('/api/mqtt/config', { cache: 'no-store' });
          if (!res.ok) throw new Error('Config failed');
          const config = await res.json();

          const set = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.value = value ?? '';
          };
          const topics = config.topics || {};

          set('mqtt-scheme', config.scheme || 'mqtt');
          set('mqtt-host', config.host || '');
          set('mqtt-port', config.port != null ? String(config.port) : '');
          set('mqtt-username', config.username || '');
          set('mqtt-password', config.password || '');
          set('mqtt-keepalive', config.keepalive != null ? String(config.keepalive) : '');
          set('mqtt-qos', config.default_qos != null ? String(config.default_qos) : '');

          const retain = document.getElementById('mqtt-retain');
          if (retain) retain.checked = Boolean(config.retain);

          set('mqtt-status-topic', topics.status || '');
          set('mqtt-metrics-topic', topics.metrics || '');
          set('mqtt-config-topic', topics.config || '');
          set('mqtt-can-raw-topic', topics.can_raw || '');
          set('mqtt-can-decoded-topic', topics.can_decoded || '');
          set('mqtt-can-ready-topic', topics.can_ready || '');

          displayMessage('');
        } catch (err) {
          displayMessage('Échec du chargement de la configuration.', true);
        }
      }

      function displayMessage(msg, error = false) {
        const el = document.getElementById('mqtt-config-message');
        if (!el) return;
        el.textContent = msg;
        el.classList.toggle('text-danger', error);
        el.classList.toggle('text-success', !error && msg);
      }

      // Handle form submission
      async function handleSubmit(e) {
        e.preventDefault();
        const form = e.currentTarget;
        const btn = form.querySelector('button[type="submit"]');
        if (btn) btn.disabled = true;
        displayMessage('Enregistrement…');

        try {
          const payload = {
            scheme: form.scheme?.value || 'mqtt',
            host: form.host?.value?.trim() || '',
            port: Number.parseInt(form.port?.value, 10) || 0,
            username: form.username?.value?.trim() || '',
            password: form.password?.value || '',
            retain: form.retain?.checked || false,
            status_topic: form.status_topic?.value?.trim() || '',
            metrics_topic: form.metrics_topic?.value?.trim() || '',
            config_topic: form.config_topic?.value?.trim() || '',
            can_raw_topic: form.can_raw_topic?.value?.trim() || '',
            can_decoded_topic: form.can_decoded_topic?.value?.trim() || '',
            can_ready_topic: form.can_ready_topic?.value?.trim() || '',
          };

          const keepalive = Number.parseInt(form.keepalive?.value, 10);
          if (!Number.isNaN(keepalive)) payload.keepalive = keepalive;
          const qos = Number.parseInt(form.default_qos?.value, 10);
          if (!Number.isNaN(qos)) payload.default_qos = qos;

          const res = await fetch('/api/mqtt/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          if (!res.ok) throw new Error(await res.text() || 'Update failed');

          await Promise.all([fetchMqttConfig(), fetchMqttStatus()]);
          displayMessage('Configuration mise à jour avec succès !', false);
        } catch (err) {
          displayMessage(`Échec: ${err.message}`, true);
        } finally {
          if (btn) btn.disabled = false;
        }
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('mqtt-config-form');
        if (form) form.addEventListener('submit', handleSubmit);

        const refresh = document.getElementById('mqtt-refresh');
        if (refresh) refresh.addEventListener('click', fetchMqttStatus);

        // Initial load
        fetchMqttConfig();
        fetchMqttStatus();
      });
    </script>
  </body>
</html>
