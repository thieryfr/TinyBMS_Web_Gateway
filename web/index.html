<!DOCTYPE html>
<html lang="fr" data-partials-loaded="false">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TinyBMS Web Gateway</title>
    <link rel="icon" type="image/x-icon" href="../assets/favicon.ico" />

    <!-- 1. Tabler CSS + Icons -->
    <link rel="stylesheet" href="../assets/css/tabler.reduit.css" />
    <link rel="stylesheet" href="../assets/css/tabler-icons.min.css" />

    <!-- 2. Styles personnalisÃ©s -->
    <link rel="stylesheet" href="../style.css" />
    
    <!-- 3. Echarts -->
    <script src="../assets/js/echarts.common.js" type="module"></script>
  </head>
  <body class="theme-dark">
    <div id="app" class="page">
      <div data-partial="./layout/header.html"></div>
      <div data-partial="./layout/main.html"></div>
    </div>

    <script defer src="../assets/js/tabler.min.js"></script>

    <!-- Chargement des partials -->
    <script type="module">
      const DEFAULT_PARTIAL_BASE = document.baseURI;

      async function loadPartials() {
        let placeholders = Array.from(document.querySelectorAll('[data-partial]'));

        while (placeholders.length) {
          await Promise.all(
            placeholders.map(async (placeholder) => {
              const url = placeholder.getAttribute('data-partial');
              if (!url) return;

              const base = placeholder.getAttribute('data-partial-base') ?? DEFAULT_PARTIAL_BASE;
              const resolvedUrl = new URL(url, base).toString();

              try {
                const response = await fetch(resolvedUrl);
                if (!response.ok) throw new Error(`Impossible de charger ${resolvedUrl}`);

                const markup = await response.text();
                const template = document.createElement('template');
                template.innerHTML = markup.trim();

                const partialBase = resolvedUrl.slice(0, resolvedUrl.lastIndexOf('/') + 1);
                template.content.querySelectorAll('[data-partial]').forEach((node) => {
                  if (!node.hasAttribute('data-partial-base')) {
                    node.setAttribute('data-partial-base', partialBase);
                  }
                });

                placeholder.replaceWith(template.content);
              } catch (error) {
                console.error(error);
                placeholder.removeAttribute('data-partial');
              }
            })
          );

          placeholders = Array.from(document.querySelectorAll('[data-partial]'));
        }

        document.documentElement.dataset.partialsLoaded = 'true';
        document.dispatchEvent(new CustomEvent('partials-loaded'));
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadPartials);
      } else {
        loadPartials();
      }
    </script>

    <script type="module" src="../dashboard.js"></script>
  </body>
</html>
