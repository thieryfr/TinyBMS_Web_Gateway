<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="node_modules/@tabler/core/dist/css/tabler.min.css">
    <link rel="stylesheet" href="node_modules/@tabler/icons-webfont/dist/tabler-icons.min.css">
    <link rel="stylesheet" href="style.css">
    <title>TinyBMS Web Gateway</title>
</head>
<body>
    <div id="app">
        <header class="app-header">
            <div class="branding">
                <h1>TinyBMS Web Gateway</h1>
                <span class="subtitle">Système de monitoring et configuration ESP32-CAN-X2</span>
            </div>
            <nav class="tabs" aria-label="Navigation principale">
                <button class="tab-button active" data-tab="battery">Temps réel – Batterie</button>
                <button class="tab-button" data-tab="uart">Temps réel – UART</button>
                <button class="tab-button" data-tab="can">Temps réel – CAN Bus</button>
                <button class="tab-button" data-tab="history">Historique</button>
                <button class="tab-button" data-tab="config">Configuration</button>
                <button class="tab-button" data-tab="mqtt">MQTT</button>
            </nav>
        </header>
        <main>
            <section id="tab-battery" class="tab-panel active" aria-labelledby="Temps réel – Batterie">
                <div class="row row-cards g-3">
                    <div class="col-sm-6 col-xl-3">
                        <article class="card card-stats h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h2 class="card-title text-uppercase fs-6 text-secondary mb-1">Tension pack</h2>
                                        <p class="display-6 fw-bold text-white mb-1" id="battery-voltage">-- V</p>
                                        <span class="text-secondary" id="battery-minmax">min -- mV • max -- mV</span>
                                    </div>
                                    <span class="avatar avatar-lg bg-primary-lt text-primary shadow-sm">
                                        <i class="ti ti-bolt fs-2"></i>
                                    </span>
                                </div>
                            </div>
                        </article>
                    </div>
                    <div class="col-sm-6 col-xl-3">
                        <article class="card card-stats h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h2 class="card-title text-uppercase fs-6 text-secondary mb-1">Courant pack</h2>
                                        <p class="display-6 fw-bold text-white mb-1" id="battery-current">-- A</p>
                                        <span class="text-secondary" id="battery-balancing">Équilibrage: --</span>
                                    </div>
                                    <span class="avatar avatar-lg bg-warning-lt text-warning shadow-sm">
                                        <i class="ti ti-current-ac fs-2"></i>
                                    </span>
                                </div>
                                <div class="chart-sparkline mt-3" id="battery-pack-sparkline" role="img" aria-label="Évolution récente de la tension et du courant pack"></div>
                            </div>
                        </article>
                    </div>
                    <div class="col-sm-6 col-xl-3">
                        <article class="card card-stats h-100">
                            <div class="card-body">
                                <div class="d-flex flex-column flex-xl-row justify-content-between align-items-xl-center gap-3">
                                    <div class="w-100">
                                        <h2 class="card-title text-uppercase fs-6 text-secondary mb-2">État de charge</h2>
                                        <div class="d-flex flex-wrap gap-2">
                                            <span class="badge bg-green-lt text-green fw-semibold px-3 py-2">
                                                SOC <span id="battery-soc">-- %</span>
                                            </span>
                                            <span class="badge bg-blue-lt text-blue fw-semibold px-3 py-2">
                                                SOH <span id="battery-soh">-- %</span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="chart-gauge" id="battery-soc-gauge" role="img" aria-label="État de charge et de santé de la batterie"></div>
                                </div>
                            </div>
                        </article>
                    </div>
                    <div class="col-sm-6 col-xl-3">
                        <article class="card card-stats h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h2 class="card-title text-uppercase fs-6 text-secondary mb-1">Températures</h2>
                                        <p class="display-6 fw-bold text-white mb-1" id="battery-temperature">-- °C</p>
                                        <span class="text-secondary" id="battery-temp-extra">MOSFET: -- °C</span>
                                    </div>
                                    <span class="avatar avatar-lg bg-orange-lt text-orange shadow-sm">
                                        <i class="ti ti-temperature fs-2"></i>
                                    </span>
                                </div>
                            </div>
                        </article>
                    </div>
                </div>
                <div class="row g-3 status-grid mt-3">
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header d-flex align-items-center gap-2">
                                <span class="status-icon text-danger"><i class="ti ti-alert-triangle"></i></span>
                                <h3 class="card-title mb-0">Alarmes</h3>
                            </div>
                            <div id="battery-alarms" class="list-group list-group-flush" role="list"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header d-flex align-items-center gap-2">
                                <span class="status-icon text-warning"><i class="ti ti-alert-circle"></i></span>
                                <h3 class="card-title mb-0">Avertissements</h3>
                            </div>
                            <div id="battery-warnings" class="list-group list-group-flush" role="list"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header d-flex align-items-center gap-2">
                                <span class="status-icon text-info"><i class="ti ti-info-circle"></i></span>
                                <h3 class="card-title mb-0">Informations système</h3>
                            </div>
                            <div class="card-body">
                                <dl class="status-kv" id="battery-system-info"></dl>
                            </div>
                        </div>
                    </div>
                </div>
                <section id="battery-cell-section" class="card cell-section mt-4" aria-labelledby="cell-section-title">
                    <div class="card-header cell-section-header d-flex flex-column flex-lg-row gap-3 align-items-lg-center justify-content-between">
                        <div>
                            <h3 class="card-title" id="cell-section-title">Équilibrage des cellules</h3>
                            <p class="card-subtitle" id="cell-section-description">Visualisez les tensions individuelles des cellules 1 à 16 et leur état d’équilibrage.</p>
                        </div>
                        <div class="text-secondary small" id="battery-cell-summary"></div>
                    </div>
                    <div class="card-body">
                        <div class="row g-4 align-items-start">
                            <div class="col-lg-8">
                                <div id="battery-cell-chart" class="echart-container" role="img" aria-label="Répartition normalisée des tensions des cellules"></div>
                            </div>
                            <div class="col-lg-4">
                                <h4 class="text-secondary text-uppercase fs-6 mb-3">Équilibrage actif</h4>
                                <div id="battery-balancing-badges" class="cell-balancing-badges d-flex flex-wrap gap-2" aria-live="polite"></div>
                            </div>
                        </div>
                    </div>
                </section>
                <div class="card register-table mt-4">
                    <div class="card-header">
                        <h3 class="card-title">Registres TinyBMS surveillés</h3>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped mb-0">
                                <thead>
                                    <tr>
                                        <th>Adresse</th>
                                        <th>Valeur brute</th>
                                    </tr>
                                </thead>
                                <tbody id="battery-registers"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            <section id="tab-uart" class="tab-panel" aria-labelledby="Temps réel – UART">
                <div class="row g-3">
                    <div class="col-xl-5">
                        <div class="card h-100">
                            <div class="card-header d-flex align-items-center gap-3">
                                <h3 class="card-title mb-0">Flux UART en direct</h3>
                                <div class="ms-auto segmented-control segmented-control-sm" role="tablist" aria-label="Vue des trames UART">
                                    <input type="radio" name="uart-view" value="raw" id="uart-view-raw" checked>
                                    <label class="segmented-control-label" for="uart-view-raw">
                                        <i class="ti ti-terminal-2 me-1"></i>
                                        Brutes
                                    </label>
                                    <input type="radio" name="uart-view" value="decoded" id="uart-view-decoded">
                                    <label class="segmented-control-label" for="uart-view-decoded">
                                        <i class="ti ti-settings-code me-1"></i>
                                        Décodées
                                    </label>
                                </div>
                            </div>
                            <div class="card-body">
                                <ol class="timeline timeline-compact" id="uart-timeline-raw" data-uart-view="raw" aria-live="polite"></ol>
                                <ol class="timeline timeline-compact d-none" id="uart-timeline-decoded" data-uart-view="decoded" aria-live="polite"></ol>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-7">
                        <div class="card h-100">
                            <div class="card-header d-flex align-items-center gap-2">
                                <h3 class="card-title mb-0">Distribution des longueurs de trames</h3>
                                <span class="badge bg-cyan-lt text-cyan ms-auto">UART</span>
                            </div>
                            <div class="card-body">
                                <div id="uart-frames-chart" class="echart-container" role="img" aria-label="Distribution des longueurs de trames UART"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="tab-can" class="tab-panel" aria-labelledby="Temps réel – CAN Bus">
                <div class="row g-3">
                    <div class="col-xl-5">
                        <div class="card h-100">
                            <div class="card-header d-flex align-items-center gap-3">
                                <h3 class="card-title mb-0">Flux CAN en direct</h3>
                                <div class="ms-auto segmented-control segmented-control-sm" role="tablist" aria-label="Vue des trames CAN">
                                    <input type="radio" name="can-view" value="raw" id="can-view-raw" checked>
                                    <label class="segmented-control-label" for="can-view-raw">
                                        <i class="ti ti-antenna-bars-5 me-1"></i>
                                        Brutes
                                    </label>
                                    <input type="radio" name="can-view" value="decoded" id="can-view-decoded">
                                    <label class="segmented-control-label" for="can-view-decoded">
                                        <i class="ti ti-device-analytics me-1"></i>
                                        Décodées
                                    </label>
                                </div>
                            </div>
                            <div class="card-body">
                                <ol class="timeline timeline-compact" id="can-timeline-raw" data-can-view="raw" aria-live="polite"></ol>
                                <ol class="timeline timeline-compact d-none" id="can-timeline-decoded" data-can-view="decoded" aria-live="polite"></ol>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-7">
                        <div class="card h-100">
                            <div class="card-header d-flex flex-wrap align-items-center gap-2">
                                <h3 class="card-title mb-0">Analyse du trafic CAN</h3>
                                <div class="d-flex flex-wrap gap-2 ms-auto">
                                    <label for="can-filter-source" class="visually-hidden">Type de trames</label>
                                    <select id="can-filter-source" class="form-select form-select-sm" aria-label="Filtrer le type de trames CAN">
                                        <option value="all" selected>Toutes les trames</option>
                                        <option value="raw">Brutes uniquement</option>
                                        <option value="decoded">Décodées uniquement</option>
                                    </select>
                                    <label for="can-filter-window" class="visually-hidden">Fenêtre temporelle</label>
                                    <select id="can-filter-window" class="form-select form-select-sm" aria-label="Fenêtre temporelle d'analyse">
                                        <option value="60">60 s</option>
                                        <option value="300" selected>5 min</option>
                                        <option value="900">15 min</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-4">
                                    <h4 class="card-subtitle text-secondary text-uppercase fs-6 mb-2">Heatmap des identifiants</h4>
                                    <div id="can-heatmap-chart" class="echart-container" role="img" aria-label="Heatmap des identifiants CAN"></div>
                                </div>
                                <div>
                                    <h4 class="card-subtitle text-secondary text-uppercase fs-6 mb-2">Débit par fenêtre</h4>
                                    <div id="can-throughput-chart" class="echart-container" role="img" aria-label="Histogramme des débits CAN"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="tab-history" class="tab-panel" aria-labelledby="Historique">
                <div class="history-toolbar">
                    <div class="history-group">
                        <label for="history-source">Source</label>
                        <select id="history-source">
                            <option value="live" selected>Temps réel (RAM)</option>
                            <option value="archive">Archives flash</option>
                        </select>
                    </div>
                    <div class="history-group" id="history-range-group">
                        <label for="history-range">Nombre de points</label>
                        <select id="history-range">
                            <option value="60">60</option>
                            <option value="120" selected>120</option>
                            <option value="240">240</option>
                            <option value="0">Tous</option>
                        </select>
                    </div>
                    <button id="history-refresh">Rafraîchir</button>
                    <button id="history-export">Exporter CSV</button>
                    <span id="history-storage-status" class="history-status" aria-live="polite">Flash: --</span>
                </div>
                <div id="history-archive-controls" class="history-archive-controls" aria-live="polite">
                    <label for="history-archive-file">Archive</label>
                    <select id="history-archive-file"></select>
                    <button id="history-archive-download">Télécharger</button>
                    <p id="history-archive-info" class="history-info"></p>
                </div>
                <canvas id="history-chart" width="800" height="320" role="img" aria-label="Évolution tension et courant"></canvas>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Horodatage</th>
                            <th>Tension (V)</th>
                            <th>Courant (A)</th>
                            <th>SOC (%)</th>
                            <th>Température (°C)</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body"></tbody>
                </table>
            </section>
            <section id="tab-config" class="tab-panel" aria-labelledby="Configuration">
                <div class="config-header">
                    <div class="config-header-text">
                        <h2>Paramètres TinyBMS</h2>
                        <p class="config-description">Configurez le réseau Wi-Fi, l’interface CAN Victron et la fréquence d’interrogation UART.</p>
                    </div>
                    <div class="config-header-actions">
                        <button id="config-refresh" type="button" class="button secondary">Recharger</button>
                        <span id="config-status" role="status">Chargement de la configuration…</span>
                    </div>
                </div>
                <form id="general-config-form" class="config-form-grid" autocomplete="off">
                    <article class="config-card">
                        <h3>Appareil &amp; UART</h3>
                        <label class="config-field" for="device-name">
                            <span>Nom du dispositif</span>
                            <input id="device-name" name="device_name" type="text" maxlength="64" required>
                        </label>
                        <label class="config-field" for="uart-poll-interval">
                            <span>Intervalle de sondage UART (ms)</span>
                            <input id="uart-poll-interval" name="uart_poll_interval_ms" type="number" min="100" max="600000" step="10" required>
                        </label>
                        <label class="config-field" for="uart-tx-gpio">
                            <span>GPIO UART TX</span>
                            <input id="uart-tx-gpio" name="uart_tx_gpio" type="number" min="-1" max="48" required>
                        </label>
                        <label class="config-field" for="uart-rx-gpio">
                            <span>GPIO UART RX</span>
                            <input id="uart-rx-gpio" name="uart_rx_gpio" type="number" min="-1" max="48" required>
                        </label>
                    </article>
                    <article class="config-card">
                        <h3>Wi-Fi station</h3>
                        <label class="config-field" for="wifi-sta-ssid">
                            <span>SSID</span>
                            <input id="wifi-sta-ssid" name="wifi_sta_ssid" type="text" maxlength="32">
                        </label>
                        <label class="config-field" for="wifi-sta-password">
                            <span>Mot de passe</span>
                            <input id="wifi-sta-password" name="wifi_sta_password" type="password" maxlength="64" autocomplete="new-password">
                        </label>
                        <label class="config-field" for="wifi-sta-hostname">
                            <span>Nom d’hôte</span>
                            <input id="wifi-sta-hostname" name="wifi_sta_hostname" type="text" maxlength="32">
                        </label>
                        <label class="config-field" for="wifi-sta-max-retry">
                            <span>Nombre de tentatives</span>
                            <input id="wifi-sta-max-retry" name="wifi_sta_max_retry" type="number" min="0" max="255" required>
                        </label>
                    </article>
                    <article class="config-card">
                        <h3>Wi-Fi point d’accès</h3>
                        <label class="config-field" for="wifi-ap-ssid">
                            <span>SSID</span>
                            <input id="wifi-ap-ssid" name="wifi_ap_ssid" type="text" maxlength="32">
                        </label>
                        <label class="config-field" for="wifi-ap-password">
                            <span>Mot de passe</span>
                            <input id="wifi-ap-password" name="wifi_ap_password" type="password" maxlength="64" autocomplete="new-password">
                        </label>
                        <label class="config-field" for="wifi-ap-channel">
                            <span>Canal</span>
                            <input id="wifi-ap-channel" name="wifi_ap_channel" type="number" min="1" max="13" required>
                        </label>
                        <label class="config-field" for="wifi-ap-max-clients">
                            <span>Clients simultanés</span>
                            <input id="wifi-ap-max-clients" name="wifi_ap_max_clients" type="number" min="1" max="10" required>
                        </label>
                    </article>
                    <article class="config-card">
                        <h3>CAN Victron</h3>
                        <label class="config-field" for="can-tx-gpio">
                            <span>GPIO TX</span>
                            <input id="can-tx-gpio" name="can_tx_gpio" type="number" min="-1" max="39" required>
                        </label>
                        <label class="config-field" for="can-rx-gpio">
                            <span>GPIO RX</span>
                            <input id="can-rx-gpio" name="can_rx_gpio" type="number" min="-1" max="39" required>
                        </label>
                        <label class="config-field" for="can-keepalive-interval">
                            <span>Intervalle keepalive (ms)</span>
                            <input id="can-keepalive-interval" name="can_keepalive_interval_ms" type="number" min="10" max="600000" step="10" required>
                        </label>
                        <label class="config-field" for="can-keepalive-timeout">
                            <span>Délai d’expiration (ms)</span>
                            <input id="can-keepalive-timeout" name="can_keepalive_timeout_ms" type="number" min="100" max="600000" step="10" required>
                        </label>
                        <label class="config-field" for="can-keepalive-retry">
                            <span>Relance keepalive (ms)</span>
                            <input id="can-keepalive-retry" name="can_keepalive_retry_ms" type="number" min="10" max="600000" step="10" required>
                        </label>
                        <label class="config-field" for="can-publisher-period">
                            <span>Période publication CAN (ms)</span>
                            <input id="can-publisher-period" name="can_publisher_period_ms" type="number" min="0" max="600000" step="10" required>
                        </label>
                    </article>
                    <article class="config-card">
                        <h3>Identité Victron</h3>
                        <label class="config-field" for="can-handshake">
                            <span>Handshake ASCII</span>
                            <input id="can-handshake" name="can_handshake_ascii" type="text" maxlength="8">
                        </label>
                        <label class="config-field" for="can-manufacturer">
                            <span>Constructeur</span>
                            <input id="can-manufacturer" name="can_manufacturer" type="text" maxlength="32">
                        </label>
                        <label class="config-field" for="can-battery-name">
                            <span>Nom batterie</span>
                            <input id="can-battery-name" name="can_battery_name" type="text" maxlength="32">
                        </label>
                        <label class="config-field" for="can-battery-family">
                            <span>Famille batterie</span>
                            <input id="can-battery-family" name="can_battery_family" type="text" maxlength="32">
                        </label>
                        <label class="config-field" for="can-serial-number">
                            <span>Numéro de série</span>
                            <input id="can-serial-number" name="can_serial_number" type="text" maxlength="32">
                        </label>
                    </article>
                    <div class="config-form-actions">
                        <button id="general-config-reset" type="button" class="button secondary">Réinitialiser</button>
                        <button type="submit" class="button primary">Enregistrer</button>
                    </div>
                </form>
                <h3 class="config-subheading">Registres TinyBMS</h3>
                <div id="config-registers" class="config-grid" role="form"></div>
            </section>
            <section id="tab-mqtt" class="tab-panel" aria-labelledby="MQTT">
                <div class="mqtt-layout">
                    <article class="status-card">
                        <h2>État de la passerelle MQTT</h2>
                        <div class="status-indicator">
                            <span id="mqtt-connection-state" class="status-badge">--</span>
                            <span id="mqtt-last-error" class="status-helper">Aucune erreur</span>
                        </div>
                        <dl class="status-kv">
                            <div><dt>Client</dt><dd id="mqtt-client-started">--</dd></div>
                            <div><dt>Wi-Fi</dt><dd id="mqtt-wifi-state">--</dd></div>
                            <div><dt>Reconnexions</dt><dd id="mqtt-reconnect-count">0</dd></div>
                            <div><dt>Déconnexions</dt><dd id="mqtt-disconnect-count">0</dd></div>
                            <div><dt>Erreurs</dt><dd id="mqtt-error-count">0</dd></div>
                            <div><dt>Dernier événement</dt><dd id="mqtt-last-event">--</dd></div>
                            <div><dt>Horodatage</dt><dd id="mqtt-last-event-time">--</dd></div>
                        </dl>
                    </article>
                    <article class="config-card">
                        <h2>Configuration de la connexion</h2>
                        <form id="mqtt-config-form" class="mqtt-form">
                            <div class="form-row">
                                <label for="mqtt-scheme">Schéma</label>
                                <select id="mqtt-scheme" name="scheme">
                                    <option value="mqtt">mqtt</option>
                                    <option value="mqtts">mqtts</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <label for="mqtt-host">Hôte</label>
                                <input id="mqtt-host" name="host" type="text" required>
                            </div>
                            <div class="form-row">
                                <label for="mqtt-port">Port</label>
                                <input id="mqtt-port" name="port" type="number" min="1" max="65535" required>
                            </div>
                            <div class="form-row">
                                <label for="mqtt-username">Utilisateur</label>
                                <input id="mqtt-username" name="username" type="text">
                            </div>
                            <div class="form-row">
                                <label for="mqtt-password">Mot de passe</label>
                                <input id="mqtt-password" name="password" type="password">
                            </div>
                            <div class="form-row">
                                <label for="mqtt-keepalive">Keepalive (s)</label>
                                <input id="mqtt-keepalive" name="keepalive" type="number" min="0">
                            </div>
                            <div class="form-row">
                                <label for="mqtt-qos">QoS par défaut</label>
                                <input id="mqtt-qos" name="default_qos" type="number" min="0" max="2">
                            </div>
                            <div class="form-row checkbox">
                                <label for="mqtt-retain">Retenir l'état</label>
                                <input id="mqtt-retain" name="retain" type="checkbox">
                            </div>
                            <fieldset class="topic-group">
                                <legend>Topics personnalisés</legend>
                                <label for="mqtt-status-topic">Statut</label>
                                <input id="mqtt-status-topic" name="status_topic" type="text">
                                <label for="mqtt-metrics-topic">Mesures</label>
                                <input id="mqtt-metrics-topic" name="metrics_topic" type="text">
                                <label for="mqtt-config-topic">Configuration</label>
                                <input id="mqtt-config-topic" name="config_topic" type="text">
                                <label for="mqtt-can-raw-topic">CAN brut</label>
                                <input id="mqtt-can-raw-topic" name="can_raw_topic" type="text">
                                <label for="mqtt-can-decoded-topic">CAN décodé</label>
                                <input id="mqtt-can-decoded-topic" name="can_decoded_topic" type="text">
                                <label for="mqtt-can-ready-topic">CAN prêts</label>
                                <input id="mqtt-can-ready-topic" name="can_ready_topic" type="text">
                            </fieldset>
                            <button type="submit">Enregistrer la configuration</button>
                            <p id="mqtt-config-message" role="status" aria-live="polite"></p>
                        </form>
                    </article>
                </div>
            </section>
        </main>
    </div>
    <script src="dashboard.js" type="module"></script>
</body>
</html>
