<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>TinyBMS Web Gateway</title>
</head>
<body>
    <div id="app">
        <header class="app-header">
            <div class="branding">
                <h1>TinyBMS Web Gateway</h1>
                <span class="subtitle">Système de monitoring et configuration ESP32-CAN-X2</span>
            </div>
            <nav class="tabs" aria-label="Navigation principale">
                <button class="tab-button active" data-tab="battery">Temps réel – Batterie</button>
                <button class="tab-button" data-tab="uart">Temps réel – UART</button>
                <button class="tab-button" data-tab="can">Temps réel – CAN Bus</button>
                <button class="tab-button" data-tab="history">Historique</button>
                <button class="tab-button" data-tab="config">Configuration</button>
                <button class="tab-button" data-tab="mqtt">MQTT</button>
            </nav>
        </header>
        <main>
            <section id="tab-battery" class="tab-panel active" aria-labelledby="Temps réel – Batterie">
                <div class="card-grid">
                    <article class="metric-card">
                        <h2>Tension pack</h2>
                        <p class="metric" id="battery-voltage">-- V</p>
                        <span class="metric-detail" id="battery-minmax">min -- mV • max -- mV</span>
                    </article>
                    <article class="metric-card">
                        <h2>Courant pack</h2>
                        <p class="metric" id="battery-current">-- A</p>
                        <span class="metric-detail" id="battery-balancing">Équilibrage: --</span>
                    </article>
                    <article class="metric-card">
                        <h2>État de charge</h2>
                        <p class="metric" id="battery-soc">-- %</p>
                        <span class="metric-detail" id="battery-soh">SOH -- %</span>
                    </article>
                    <article class="metric-card">
                        <h2>Températures</h2>
                        <p class="metric" id="battery-temperature">-- °C</p>
                        <span class="metric-detail" id="battery-temp-extra">MOSFET: -- °C</span>
                    </article>
                </div>
                <div class="status-grid">
                    <div class="status-card">
                        <h3>Alarmes</h3>
                        <ul id="battery-alarms" class="status-list"></ul>
                    </div>
                    <div class="status-card">
                        <h3>Avertissements</h3>
                        <ul id="battery-warnings" class="status-list"></ul>
                    </div>
                    <div class="status-card">
                        <h3>Informations système</h3>
                        <dl class="status-kv" id="battery-system-info"></dl>
                    </div>
                </div>
                <div class="register-table">
                    <h3>Registres TinyBMS surveillés</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Adresse</th>
                                <th>Valeur brute</th>
                            </tr>
                        </thead>
                        <tbody id="battery-registers"></tbody>
                    </table>
                </div>
            </section>
            <section id="tab-uart" class="tab-panel" aria-labelledby="Temps réel – UART">
                <div class="split-panel">
                    <section>
                        <header><h2>Trames brutes</h2></header>
                        <ul id="uart-raw-list" class="data-list"></ul>
                    </section>
                    <section>
                        <header><h2>Décodage TinyBMS</h2></header>
                        <ul id="uart-decoded-list" class="data-list"></ul>
                    </section>
                </div>
            </section>
            <section id="tab-can" class="tab-panel" aria-labelledby="Temps réel – CAN Bus">
                <div class="split-panel">
                    <section>
                        <header><h2>Trames CAN brutes</h2></header>
                        <ul id="can-raw-list" class="data-list"></ul>
                    </section>
                    <section>
                        <header><h2>Décodage Victron</h2></header>
                        <ul id="can-decoded-list" class="data-list"></ul>
                    </section>
                </div>
            </section>
            <section id="tab-history" class="tab-panel" aria-labelledby="Historique">
                <div class="history-toolbar">
                    <label for="history-range">Nombre de points</label>
                    <select id="history-range">
                        <option value="60">60</option>
                        <option value="120" selected>120</option>
                        <option value="240">240</option>
                        <option value="0">Tous</option>
                    </select>
                    <button id="history-refresh">Rafraîchir</button>
                    <button id="history-export">Exporter CSV</button>
                </div>
                <canvas id="history-chart" width="800" height="320" role="img" aria-label="Évolution tension et courant"></canvas>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Horodatage</th>
                            <th>Tension (V)</th>
                            <th>Courant (A)</th>
                            <th>SOC (%)</th>
                            <th>Température (°C)</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body"></tbody>
                </table>
            </section>
            <section id="tab-config" class="tab-panel" aria-labelledby="Configuration">
                <div class="config-header">
                    <h2>Paramètres TinyBMS</h2>
                    <p id="config-status" role="status">Chargement des registres…</p>
                </div>
                <div id="config-registers" class="config-grid" role="form"></div>
            </section>
            <section id="tab-mqtt" class="tab-panel" aria-labelledby="MQTT">
                <div class="mqtt-layout">
                    <article class="status-card">
                        <h2>État de la passerelle MQTT</h2>
                        <div class="status-indicator">
                            <span id="mqtt-connection-state" class="status-badge">--</span>
                            <span id="mqtt-last-error" class="status-helper">Aucune erreur</span>
                        </div>
                        <dl class="status-kv">
                            <div><dt>Client</dt><dd id="mqtt-client-started">--</dd></div>
                            <div><dt>Wi-Fi</dt><dd id="mqtt-wifi-state">--</dd></div>
                            <div><dt>Reconnexions</dt><dd id="mqtt-reconnect-count">0</dd></div>
                            <div><dt>Déconnexions</dt><dd id="mqtt-disconnect-count">0</dd></div>
                            <div><dt>Erreurs</dt><dd id="mqtt-error-count">0</dd></div>
                            <div><dt>Dernier événement</dt><dd id="mqtt-last-event">--</dd></div>
                            <div><dt>Horodatage</dt><dd id="mqtt-last-event-time">--</dd></div>
                        </dl>
                    </article>
                    <article class="config-card">
                        <h2>Configuration de la connexion</h2>
                        <form id="mqtt-config-form" class="mqtt-form">
                            <div class="form-row">
                                <label for="mqtt-scheme">Schéma</label>
                                <select id="mqtt-scheme" name="scheme">
                                    <option value="mqtt">mqtt</option>
                                    <option value="mqtts">mqtts</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <label for="mqtt-host">Hôte</label>
                                <input id="mqtt-host" name="host" type="text" required>
                            </div>
                            <div class="form-row">
                                <label for="mqtt-port">Port</label>
                                <input id="mqtt-port" name="port" type="number" min="1" max="65535" required>
                            </div>
                            <div class="form-row">
                                <label for="mqtt-username">Utilisateur</label>
                                <input id="mqtt-username" name="username" type="text">
                            </div>
                            <div class="form-row">
                                <label for="mqtt-password">Mot de passe</label>
                                <input id="mqtt-password" name="password" type="password">
                            </div>
                            <div class="form-row">
                                <label for="mqtt-keepalive">Keepalive (s)</label>
                                <input id="mqtt-keepalive" name="keepalive" type="number" min="0">
                            </div>
                            <div class="form-row">
                                <label for="mqtt-qos">QoS par défaut</label>
                                <input id="mqtt-qos" name="default_qos" type="number" min="0" max="2">
                            </div>
                            <div class="form-row checkbox">
                                <label for="mqtt-retain">Retenir l'état</label>
                                <input id="mqtt-retain" name="retain" type="checkbox">
                            </div>
                            <fieldset class="topic-group">
                                <legend>Topics personnalisés</legend>
                                <label for="mqtt-status-topic">Statut</label>
                                <input id="mqtt-status-topic" name="status_topic" type="text">
                                <label for="mqtt-metrics-topic">Mesures</label>
                                <input id="mqtt-metrics-topic" name="metrics_topic" type="text">
                                <label for="mqtt-config-topic">Configuration</label>
                                <input id="mqtt-config-topic" name="config_topic" type="text">
                                <label for="mqtt-can-raw-topic">CAN brut</label>
                                <input id="mqtt-can-raw-topic" name="can_raw_topic" type="text">
                                <label for="mqtt-can-decoded-topic">CAN décodé</label>
                                <input id="mqtt-can-decoded-topic" name="can_decoded_topic" type="text">
                                <label for="mqtt-can-ready-topic">CAN prêts</label>
                                <input id="mqtt-can-ready-topic" name="can_ready_topic" type="text">
                            </fieldset>
                            <button type="submit">Enregistrer la configuration</button>
                            <p id="mqtt-config-message" role="status" aria-live="polite"></p>
                        </form>
                    </article>
                </div>
            </section>
        </main>
    </div>
    <script src="dashboard.js" type="module"></script>
</body>
</html>
