<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Purge Tabler CSS - TinyBMS</title>
  <link href="assets/css/tabler.min.css" rel="stylesheet" />
  <style>
    body { font-family: system-ui, sans-serif; padding: 2rem; background: #f8f9fa; }
    .container { max-width: 900px; margin: auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { color: #206bc4; }
    button { background: #206bc4; color: white; border: none; padding: 12px 24px; font-size: 1rem; border-radius: 6px; cursor: pointer; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .log { margin-top: 1rem; font-family: monospace; background: #f1f3f5; padding: 1rem; border-radius: 6px; max-height: 300px; overflow-y: auto; }
    .progress { margin: 1rem 0; }
    .file-list { margin: 1rem 0; }
    .file-item { padding: 4px 8px; background: #e9ecef; margin: 2px 0; border-radius: 4px; font-size: 0.9rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Purge Tabler CSS</h1>
    <p>Cet outil charge toutes les pages HTML/JS du projet, extrait les classes utilisées, et génère un <strong>tabler.reduit.css</strong> allégé.</p>

    <button id="startBtn">Lancer le purge</button>
    <div class="progress" id="progress" style="display:none;">
      <div style="width: 0%; height: 8px; background: #206bc4; border-radius: 4px; transition: width 0.3s;"></div>
    </div>

    <div id="fileList" class="file-list"></div>
    <pre id="log" class="log"></pre>
  </div>

  <script>
    // === CONFIGURATION ===
    const HTML_FILES = [
      'index.html',
      'src/index.html',
      'src/layout/header.html',
      'src/layout/main.html',
      'src/components/configuration/index.html',
      'src/components/history/index.html',
      'src/components/mqtt/index.html'
    ];

    const JS_FILES = [
      'dashboard.js',
      'src/js/charts/base.js',
      'src/js/charts/batteryCharts.js',
      'src/js/charts/canCharts.js',
      'src/js/charts/uartCharts.js'
    ];

    const TABLER_CSS = 'assets/css/tabler.min.css';
    // =====================

    const log = document.getElementById('log');
    const startBtn = document.getElementById('startBtn');
    const fileList = document.getElementById('fileList');
    const progressBar = document.querySelector('.progress div');

    function addLog(msg) {
      log.textContent += msg + '\n';
      log.scrollTop = log.scrollHeight;
    }

    function addFile(name) {
      const div = document.createElement('div');
      div.className = 'file-item';
      div.textContent = 'Chargement de ' + name;
      fileList.appendChild(div);
      return div;
    }

    function updateProgress(ratio) {
      progressBar.style.width = (ratio * 100) + '%';
    }

    startBtn.onclick = async () => {
      startBtn.disabled = true;
      document.getElementById('progress').style.display = 'block';
      fileList.innerHTML = '';
      log.textContent = '';
      addLog('Démarrage du purge CSS...');

      const allClasses = new Set();

      // 1. Charger tous les fichiers
      const totalFiles = HTML_FILES.length + JS_FILES.length;
      let loaded = 0;

      const loadFile = async (path) => {
        const item = addFile(path);
        try {
          const res = await fetch(path + '?v=' + Date.now());
          if (!res.ok) throw new Error('404');
          const text = await res.text();

          // Extraire les classes
          const matches = text.match(/class=["'][^"']*["']/g) || [];
          matches.forEach(m => {
            const classes = m.slice(7, -1).split(/\s+/);
            classes.forEach(c => allClasses.add(c));
          });

          item.textContent = 'Chargement de ' + path;
          item.style.background = '#d1e7dd';
          loaded++;
          updateProgress(loaded / totalFiles);
        } catch (e) {
          item.textContent = 'Erreur ' + path + ' (' + e.message + ')';
          item.style.background = '#f8d7da';
        }
      };

      const loadPromises = [
        ...HTML_FILES.map(loadFile),
        ...JS_FILES.map(loadFile)
      ];

      await Promise.all(loadPromises);
      addLog(`Fichiers chargés : ${loaded}/${totalFiles}`);

      // 2. Charger tabler.min.css
      addLog('Chargement de tabler.min.css...');
      const cssRes = await fetch(TABLER_CSS);
      const fullCss = await cssRes.text();

      // 3. Extraire toutes les règles CSS
      const rules = [];
      const ruleRegex = /\.([a-zA-Z0-9._:\-%][a-zA-Z0-9._:\-%]*)\s*{[^}]*}/g;
      let match;
      while ((match = ruleRegex.exec(fullCss)) !== null) {
        const selector = match[1];
        const ruleBody = match[0];
        rules.push({ selector, rule: ruleBody });
      }
      addLog(`Règles CSS trouvées dans tabler.min.css : ${rules.length}`);

      // 4. Filtrer les règles utilisées
      const usedRules = rules.filter(r => {
        // Support des classes simples, combinées, et pseudo-classes
        const parts = r.selector.split(/[\s+>~]/).map(s => s.replace(/::?.*$/, ''));
        return parts.some(part => {
          // Nettoyer le sélecteur
          const clean = part.replace(/^[:.]/, '');
          return allClasses.has(clean);
        });
      });

      addLog(`Règles conservées : ${usedRules.length} / ${rules.length}`);

      // 5. Générer le CSS réduit
      const reducedCss = usedRules.map(r => r.rule).join('\n');

      // 6. Téléchargement
      const blob = new Blob([reducedCss], { type: 'text/css' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'tabler.reduit.css';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      addLog('Téléchargement terminé : tabler.reduit.css');
      addLog(`Taille estimée : ~${(reducedCss.length / 1024).toFixed(1)} KB`);

      startBtn.disabled = false;
    };
  </script>
</body>
</html>
