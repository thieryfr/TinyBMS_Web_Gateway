<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug TinyBMS</title>
    <style>
        body {
            background: #1e1e2e;
            color: #cdd6f4;
            font-family: 'Courier New', monospace;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 { color: #89b4fa; margin-bottom: 20px; }
        h2 { color: #a6e3a1; margin-top: 30px; border-bottom: 2px solid #585b70; padding-bottom: 5px; }
        .status { padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid; }
        .success { background: #1e3a2e; border-color: #a6e3a1; }
        .error { background: #3e2832; border-color: #f38ba8; }
        .warning { background: #3e3628; border-color: #f9e2af; }
        .info { background: #2e3440; border-color: #89b4fa; }
        pre {
            background: #181825;
            padding: 15px;
            overflow: auto;
            border-radius: 8px;
            border: 1px solid #45475a;
            font-size: 12px;
            line-height: 1.4;
        }
        button {
            background: #89b4fa;
            color: #1e1e2e;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        button:hover { background: #b4befe; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .value { color: #f9e2af; font-weight: bold; }
        #live-data { min-height: 200px; }
        .timestamp { color: #6c7086; font-size: 11px; }
    </style>
</head>
<body>
    <h1>üîß TinyBMS Debug Console</h1>

    <div class="grid">
        <div>
            <h2>üåê API Tests</h2>
            <button onclick="testAPI()">Test /api/status</button>
            <button onclick="testHistory()">Test /api/history</button>
            <button onclick="testRegisters()">Test /api/registers</button>
            <div id="api-results"></div>
        </div>

        <div>
            <h2>üì° WebSocket Tests</h2>
            <button onclick="testWS()">Test All WebSockets</button>
            <button onclick="disconnectWS()">Disconnect All</button>
            <div id="ws-status"></div>
        </div>
    </div>

    <h2>üìä Live Data Stream</h2>
    <pre id="live-data">Waiting for data...</pre>

    <h2>üîç DOM Elements Check</h2>
    <button onclick="checkDOM()">Check DOM Elements</button>
    <pre id="dom-check"></pre>

    <h2>üìã Console Logs</h2>
    <pre id="console-log"></pre>

    <script>
        const apiResults = document.getElementById('api-results');
        const wsStatus = document.getElementById('ws-status');
        const liveData = document.getElementById('live-data');
        const consoleLog = document.getElementById('console-log');
        const domCheck = document.getElementById('dom-check');

        let wsConnections = {};
        let dataCount = 0;

        // Intercept console.log
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function logToPage(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : a).join(' ');
            consoleLog.textContent = `[${timestamp}] [${type}] ${msg}\n` + consoleLog.textContent.slice(0, 5000);
        }

        console.log = (...args) => { originalLog(...args); logToPage('LOG', ...args); };
        console.error = (...args) => { originalError(...args); logToPage('ERROR', ...args); };
        console.warn = (...args) => { originalWarn(...args); logToPage('WARN', ...args); };

        // Test API
        async function testAPI() {
            try {
                console.log('Testing /api/status...');
                const res = await fetch('/api/status');
                const data = await res.json();

                apiResults.innerHTML = `
                    <div class="status success">
                        <strong>‚úì API Status: OK</strong><br>
                        <div class="timestamp">${new Date().toLocaleTimeString()}</div>
                        SOC: <span class="value">${data.battery?.state_of_charge_pct}%</span><br>
                        Voltage: <span class="value">${data.battery?.pack_voltage_v}V</span><br>
                        Current: <span class="value">${data.battery?.pack_current_a}A</span><br>
                        Cells: <span class="value">${data.battery?.cell_voltage_mv?.length || 0}</span>
                    </div>
                `;
                console.log('API test successful', data);
            } catch (e) {
                apiResults.innerHTML = `<div class="status error"><strong>‚úó API Failed:</strong> ${e.message}</div>`;
                console.error('API test failed', e);
            }
        }

        async function testHistory() {
            try {
                const res = await fetch('/api/history?limit=10');
                const data = await res.json();
                apiResults.innerHTML += `
                    <div class="status success">
                        <strong>‚úì History: OK</strong><br>
                        Entries: <span class="value">${data.entries?.length || 0}</span>
                    </div>
                `;
                console.log('History test successful', data);
            } catch (e) {
                apiResults.innerHTML += `<div class="status error"><strong>‚úó History Failed:</strong> ${e.message}</div>`;
                console.error('History test failed', e);
            }
        }

        async function testRegisters() {
            try {
                const res = await fetch('/api/registers');
                const data = await res.json();
                apiResults.innerHTML += `
                    <div class="status success">
                        <strong>‚úì Registers: OK</strong><br>
                        Count: <span class="value">${data.registers?.length || 0}</span>
                    </div>
                `;
                console.log('Registers test successful', data);
            } catch (e) {
                apiResults.innerHTML += `<div class="status error"><strong>‚úó Registers Failed:</strong> ${e.message}</div>`;
                console.error('Registers test failed', e);
            }
        }

        // Test WebSockets
        function testWS() {
            const endpoints = ['/ws/telemetry', '/ws/events', '/ws/uart', '/ws/can'];
            wsStatus.innerHTML = '<div class="status info">Connecting to WebSockets...</div>';

            endpoints.forEach(path => {
                const url = `ws://${window.location.host}${path}`;
                console.log(`Connecting to ${url}...`);

                const ws = new WebSocket(url);
                wsConnections[path] = ws;

                ws.onopen = () => {
                    console.log(`‚úì ${path} connected`);
                    updateWSStatus();
                };

                ws.onmessage = (event) => {
                    dataCount++;
                    const data = JSON.parse(event.data);

                    if (path === '/ws/telemetry') {
                        liveData.textContent = `[${new Date().toLocaleTimeString()}] Telemetry #${dataCount}\n` +
                                               JSON.stringify(data, null, 2).slice(0, 1000);
                    }

                    console.log(`Data from ${path}:`, data);
                };

                ws.onerror = (error) => {
                    console.error(`‚úó ${path} error:`, error);
                    updateWSStatus();
                };

                ws.onclose = () => {
                    console.log(`‚úó ${path} closed`);
                    updateWSStatus();
                };
            });
        }

        function updateWSStatus() {
            let html = '';
            for (const [path, ws] of Object.entries(wsConnections)) {
                const states = ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED'];
                const state = states[ws.readyState];
                const statusClass = ws.readyState === 1 ? 'success' : 'warning';
                html += `<div class="status ${statusClass}">${path}: <span class="value">${state}</span></div>`;
            }
            wsStatus.innerHTML = html || '<div class="status info">No connections</div>';
        }

        function disconnectWS() {
            for (const ws of Object.values(wsConnections)) {
                ws.close();
            }
            wsConnections = {};
            updateWSStatus();
        }

        // Check DOM elements
        function checkDOM() {
            const requiredIds = [
                'battery-voltage', 'battery-current', 'battery-soc', 'battery-soh',
                'battery-temperature', 'battery-minmax', 'battery-balancing',
                'battery-temp-extra', 'battery-system-info', 'battery-alarms',
                'battery-warnings', 'battery-registers', 'battery-cell-summary',
                'battery-balancing-badges', 'tab-battery', 'tab-uart', 'tab-can'
            ];

            let found = 0;
            let missing = [];
            let result = 'Checking DOM elements...\n\n';

            requiredIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    found++;
                    result += `‚úì ${id}\n`;
                } else {
                    missing.push(id);
                    result += `‚úó ${id} - MISSING\n`;
                }
            });

            result += `\n\nSummary: ${found}/${requiredIds.length} elements found\n`;
            if (missing.length > 0) {
                result += `\nMissing: ${missing.join(', ')}`;
            }

            // Check for tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            result += `\n\nTab buttons found: ${tabButtons.length}`;

            // Check for tab panels
            const tabPanels = document.querySelectorAll('.tab-panel');
            result += `\nTab panels found: ${tabPanels.length}`;

            domCheck.textContent = result;
            console.log('DOM check complete', { found, missing, tabButtons: tabButtons.length, tabPanels: tabPanels.length });
        }

        // Auto-test on load
        window.onload = () => {
            console.log('Debug page loaded');
            setTimeout(testAPI, 500);
            setTimeout(testWS, 1000);
            setTimeout(checkDOM, 1500);
        };
    </script>
</body>
</html>
